<!DOCTYPE html><html lang="ru"><head>
    <meta charset="UTF-8">
    <title>Bunker - by lvyzap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <style>
        /* === СТИЛИ ИНТЕРФЕЙСА === */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        body { background: #000 url('https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/481110/ss_f6759e27cb0d2d3770b3554ead377589ae910b4e.1920x1080.jpg') center/cover fixed; color: #fff; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        :root { --frost: #e0f7fa; }
        .overlay { background: rgba(0, 0, 0, 0.45); min-height: 100vh; padding: 25px; transition: 0.5s; }
        .game-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap: 40px; max-width: 1950px; margin: 0 auto; }
        .p-card { background: rgba(255, 255, 255, 0.07); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 24px; padding: 24px; position: relative; transition: 0.6s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; min-height: 850px; backdrop-filter: blur(25px); }
        .is-exiled-card { opacity: 0.3; filter: grayscale(1) brightness(0.5); transform: scale(0.95); }
        .stat-box { padding: 10px; border-radius: 12px; transition: 0.3s; border: 1px solid transparent; }
        .stat-revealed { background: rgba(255, 255, 255, 0.15) !important; border: 2px solid rgba(255, 255, 255, 0.8) !important; box-shadow: 0 0 20px rgba(255, 255, 255, 0.2), inset 0 0 10px rgba(255, 255, 255, 0.1); transform: scale(1.02);}        
        .focus-mode .game-grid { display: flex; justify-content: center; align-items: center; min-height: 60vh; margin-top: 100px; padding-bottom: 50px; }
        .focus-mode .p-card:not(.speaking-card) { display: none !important; }
        .speaking-card { transform: scale(1.15) !important; z-index: 1000 !important; border: 4px solid white !important; box-shadow: 0 0 150px rgba(255, 255, 255, 0.3) !important; background: rgba(255, 255, 255, 0.15) !important; opacity: 1 !important; filter: none !important; }
        .target-out { border: 4px solid #ff3e3e !important; animation: heart-pulse 2s infinite ease-in-out; }
        .stat-label { font-size: 9px; color: var(--frost); font-weight: 900; text-transform: uppercase; opacity: 0.8; letter-spacing: 1.5px; margin-bottom: 4px; display: block; }
        .blur-val { filter: blur(18px); color: transparent !important; user-select: none; }
        .v-slot { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 13px; cursor: pointer; background: rgba(255,255,255,0.1); border-radius: 10px; color: #555; border: 1px solid #444; transition: 0.2s; }
        .v-slot.active { color: #fff; box-shadow: 0 0 25px white; border-color: white; background: rgba(255,255,255,0.3); }
        .glass-overlay { position: fixed; inset: 0; z-index: 99999; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(45px); }
        .glass-box { background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255,255,255,0.3); border-radius: 50px; text-align: center; max-width: 600px; width: 90%; padding: 60px; box-shadow: 0 0 100px rgba(0,0,0,0.5); }
        .bunker-info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; max-width: 1900px; margin: 0 auto 50px auto; }
        .info-block { background: rgba(255, 255, 255, 0.07); border-left: 8px solid white; padding: 25px; border-radius: 20px; backdrop-filter: blur(20px); }
        .info-block textarea { height: 180px; font-size: 19px; line-height: 1.4; border: none !important; background: transparent !important; color: white; width: 100%; resize: none; font-weight: 700; outline: none; }
        .event-overlay { position: fixed; inset: 0; z-index: 8000; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(35px); pointer-events: none; }
        .event-box { background: rgba(10, 10, 30, 0.8); border: 2px solid #3b82f6; border-radius: 40px; padding: 50px; text-align: center; max-width: 800px; box-shadow: 0 0 150px rgba(59,130,246,0.4); pointer-events: auto; }
        .stamp-exile { position: absolute; inset: 0; z-index: 500; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .stamp-text { color: #ff3e3e; font-size: 60px; font-weight: 900; border: 10px solid #ff3e3e; padding: 10px 40px; transform: rotate(-15deg); text-transform: uppercase; background: rgba(0,0,0,0.6); border-radius: 20px; }
        @keyframes heart-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        input, .stat-input { background: transparent !important; border: none !important; color: #fff; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.1) !important; font-weight: 800; outline: none; }
        textarea:disabled, input:disabled { background: transparent !important; color: rgba(255,255,255,0.7) !important; border-bottom: 1px solid transparent !important; cursor: default; }
        .p-input { background: rgba(255,255,255,0.05) !important; border: 2px solid rgba(255,255,255,0.2) !important; border-radius: 15px; padding: 15px; font-size: 30px; text-align: center; margin-bottom: 20px; color: white; width: 100%; }
        .glass-overlay {animation: fadeIn 0.4s ease-out;}
        .event-overlay, .glass-overlay {animation: slideUpFade 0.5s cubic-bezier(0.23, 1, 0.32, 1); }
        .event-box, .glass-box {animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .glass-box {animation: scaleUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes fadeIn {from { opacity: 0; backdrop-filter: blur(0px); } to { opacity: 1; backdrop-filter: blur(35px); }}
        @keyframes scaleUp {from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; }}
        @keyframes slideUpFade {from { opacity: 0; backdrop-filter: blur(0px); }to { opacity: 1; backdrop-filter: blur(45px); }}
        @keyframes popIn {from { transform: scale(0.9); opacity: 0; }to { transform: scale(1); opacity: 1; }}
        @keyframes dice-spin { 0% { transform: rotate(0deg) scale(1); } 30% { transform: rotate(180deg) scale(1.2); } 100% { transform: rotate(360deg) scale(1); }}
        .dice-rolling { animation: dice-spin 0.5s ease-out; }
        /* Адаптация для телефонов */
        @media (max-width: 768px) {
            div[class*="w-[450px]"] { 
                width: 100% !important; 
                background: rgba(0,0,0,0.98) !important; 
                z-index: 99999 !important; 
                border-left: none !important;
            }
            .game-grid { gap: 15px; }
        }
    </style></head><body>
    <div id="root"></div>
    <script type="text/babel">

        // === ПОДКЛЮЧЕНИЕ БАЗЫ ДАННЫХ (FIREBASE) ===
        const firebaseConfig = { apiKey: "AIzaSyDFISlde1kEbpqaTdsIgHxAPL_5phSB5Pw", authDomain: "bunkergamedaneq.firebaseapp.com", databaseURL: "https://bunkergamedaneq-default-rtdb.europe-west1.firebasedatabase.app", projectId: "bunkergamedaneq", storageBucket: "bunkergamedaneq.firebasestorage.app", messagingSenderId: "388224175237", appId: "1:388224175237:web:933fbbbecbdfee2c61adec" };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();
        const auth = firebase.auth();
        
        // === ЗВУКИ ===
        const sfx = { open: new Audio('з'), click: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'), stop: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'), tick: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'), raid: new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'), survivor: new Audio('https://assets.mixkit.co/active_storage/sfx/600/600-preview.mp3'), event: new Audio('https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3'), join: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3') };
        const playSfx = (sound) => { sound.currentTime = 0; sound.play().catch(e => console.log("Ждем клика...")); };

        // === БАЗЫ ДАННЫХ ===
        const MY_ACTION_CARDS = ["МЕДИК: Здоровье -> Идеал.", "ГЕНЕТИК: Репродукция -> ПЛОДОВИТ.", "ОБМЕН: Багаж соседа.", "БЛОКИРОВКА: Молчание круг.", "ШПИОН: Смотри козыри.", "МАРОДЕР: Забери лучший предмет у изгнанного.", "КАННИБАЛ: Съешь соседа, восстанови здоровье.", "ПОДСТАВА: Подбрось свой плохой факт другому.", "СУЦИДНИК: Если изгоняют тебя, забираешь любого с собой.", "ТЕРРОРИСТ: Взорви багаж троих игроков.", "ВУАЙЕРИСТ: Весь круг смотришь чужие карты действий.", "Эвтаназия: Убей игрока с критическим здоровьем.", "СЕКС-СИМВОЛ: Иммунитет к голосованию на 1 круг.", "ДОНОСЧИК: Вскрой самый грязный факт игрока.", "ВОР-РЕЦИДИВИСТ: Укради по 1 предмету у двоих.", "БЕСПЛОДИЕ: Сделай игрока бесплодным навсегда.", "РАДИАЦИЯ: Игрок получает 'Лучевую болезнь'.", "ПСИХУШКА: Замени хобби игрока на фобию.", "ЛОБОТОМИЯ: Игрок теряет профессию (теперь Овощ).", "АЛКАШ: Игрок обязан говорить только тостами весь круг.", "СЫВОРОТКА ПРАВДЫ: Игрок обязан честно ответить на 3 вопроса.", "ИУДА: Поменяй свой плохой багаж на карту действия соседа.", "ОГНЕСТРЕЛ: Нанеси травму игроку (Здоровье падает).", "КРОВНАЯ МЕСТЬ: Твой голос против обидчика считается за три.", "ПАЛАЧ: Твой голос решающий, даже если нет ничьей.", "СВАХА: Свяжи двух игроков (уходят только вместе).", "ПЕРЕДОЗ: Игрок пропускает 2 хода из-за 'глюков'.", "АМПУТАЦИЯ: Вылечи болезнь, но отними багаж (типа плата).", "ЗОМБИ: Изгнанный игрок возвращается и голосует 1 раз.", "ИНФЕКЦИЯ: Зарази соседа своей болезнью.", "СТРАХОВКА: Если тебя изгонят, ты выбираешь, кто займет твое место.", "ГНИДА: Отмени действие любой лечащей карты.", "БАРТЕР: Отдай болезнь, забери багаж.", "ЗАГРАДОТРЯД: Запрети выходить из бункера самому здоровому.", "РЕВИЗОР: Все открывают багаж, ты забираешь что хочешь.", "ШЛЮХА: Переспи с игроком, чтобы он голосовал за тебя.", "ОСЛЕПЛЕНИЕ: Игрок не видит свои карты до конца круга.", "ТРУПНЫЙ ЯД: Испорти всю еду в багаже у соседа.", "ФАНАТИК: Заставь игрока выбросить весь багаж ради спасения души.", "КРЫСИНЫЙ КОРОЛЬ: Сбрось 3 карты действия из колоды.", "ЗОЛОТАЯ ЛИХОРАДКА: Забери всё золото и драгоценности у игроков.", "ПЕРЕХВАТ: Забери карту действия, которую только что разыграли.", "ВЕТО: Запрети игроку использовать его профессию при аргументации.", "ИЗОЛЯТОР: Закрой игрока, он не участвует в обсуждении.", "ПАНИЧЕСКАЯ АТАКА: Игрок вскрывает свою фобию и молчит.", "ПЕРЕСАДКА: Забери здоровье у молодого, отдай старому.", "ГРЯЗНОЕ БЕЛЬЕ: Все узнают хобби игрока.", "НАРКОЗ: Выключи игрока на время голосования.", "ОГРАБЛЕНИЕ: Забери у игрока всё, оставь 1 предмет.", "НЕКРОФИЛ: Получи бонус за каждого изгнанного персонажа.", "ПРОФНЕПРИГОДНОСТЬ: Замени профессию соседа на 'Безработный'.", "КАРЦЕР: Лиши игрока права голоса и багажа на ход.", "МАНИПУЛЯТОР: Поменяй цели местами при голосовании.", "ЧЕРНЫЙ РЫНОК: Обменяй свой предмет на 2 карты из колоды.", "КРЫША: Заставь другого игрока защищать тебя в своей речи.", "ПОДКУП: Дай игроку предмет, чтобы он сменил голос.", "УДАЧА ДУРАКА: Твой плохой факт становится хорошим.", "ПЛАГИАТ: Скопируй профессию соседа себе.", "ОБНУЛЕНИЕ: У всех игроков пропадает весь багаж.", "ПОСЛЕДНИЙ ПАЙ: Забери еду у самого слабого.", "ТЕМНИЦА: Скрой факт любого игрока навсегда.", "ВЗРЫВАТЕЛЬ: Уничтожь 1 характеристику (на выбор) у цели.", "ПАРАЗИТ: Каждый ход забирай у соседа по 1 полезному предмету.", "АДВОКАТ ДЬЯВОЛА: Защити самого подозрительного игрока (иммунитет).", "БЕСПРЕДЕЛ: Перемешай все карты профессий между игроками.", "ТЕРПИЛА: Игрок обязан принимать на себя все негативные карты круга.", "ШЛЕМ: Защита от любой атаки на этот круг.", "РАЗОБЛАЧЕНИЕ: Покажи всем, что факт игрока — ложь.", "САНКТ-ПЕТЕРБУРГ: Расчлени багаж соседа (удали 2 предмета).", "ВУДУ: Наносишь вред себе — такой же вред получает цель.", "ПЕРЕЗАГРУЗКА: Все скидывают карты действий и берут новые.", "ЗАКЛАДКА: Найди спрятанный предмет в бункере (багаж +1).", "СКАМ: Обменяй свой пустой рюкзак на полный багаж соседа.", "ТРОЛЛЬ: Заставь игрока говорить только гадости о себе.", "ИСТЕРИКА: Игрок должен кричать свою речь, иначе изгнание.", "КОРОль БУНКЕРА: Твой голос весит как три, но ты открываешь факт.", "ПОДСОБНИК: Ты и другой игрок становитесь командой на круг.", "РЕИНКАРНАЦИЯ: Смени персонажа полностью (но сохрани багаж).", "МИННОЕ ПОЛЕ: Кто проголосует против тебя, теряет багаж.", "КИБЕРПАНК: Замени болезнь игрока на крутой имплант (факт).", "ОТРАВЛЕННЫЙ КОЛОДЕЦ: Здоровье всех падает на 1 уровень.", "ДЕФИБРИЛЛЯТОР: Спаси того, кого уже изгнали.", "ЧЕРНАЯ МЕТКА: Игрок обязан оправдываться весь круг.", "ВОРОВСКАЯ ЧЕСТЬ: Верни украденный багаж, получи 2 карты действий.", "ЭЛИТА: Профессии 'высшего класса' получают иммунитет.", "БУНТ: Голосуем только против тех, у кого есть оружие.", "ДЕВА МАРИЯ: Твоя плодовитость становится 100%, здоровье — топ.", "ГЕНОЦИД: Удали из игры всех игроков с определенной фобией.", "СТРАШНЫЙ СУД: Изгнание двоих игроков вместо одного.", "АПОКАЛИПСИС: Все открывают все свои карты прямо сейчас.", "ШИЗОФРЕНИЯ: У игрока теперь две профессии (вторая из колоды).", "МОРФИН: Игрок не чувствует эффектов болезней 2 круга.", "КРЫСИНЫЙ ЯД: Убей животное из багажа или хобби соседа.", "ПРОРОЧЕСТВО: Назови имя того, кто уйдет. Если угадала — бонус.", "ВА-БАНК: Сбрось всё, чтобы выгнать любого игрока без суда.", "ЗОЛОТАЯ МОЛОДЕЖЬ: Тебя нельзя выгнать, пока жив любой 'врач'.", "ХАКЕРСКАЯ АТАКА: Выключи свет (все голосуют вслепую).", "ДЕФИЦИТ: Запрети использовать аптечки на этом кругу.", "ШАНТАЖИСТ: Если игрок не отдаст багаж, ты вскроешь его факт.", "ТАБУ: Запрети называть профессию игрока во время обсуждения.", "ЖЕРТВОПРИНОШЕНИЕ: Скинь свой лучший предмет, чтобы спасти друга.", "НАЕМНИК: Заплати багажом, чтобы другой игрок проголосовал за тебя.", "ЖЕЛЕЗНЫЙ ЗАНАВЕС: Никто не может смотреть твои карты.", "ПЕРЕДОЗИРОВКА: Случайная смерть (вылет) игрока с 'зависимостью'.", "СЫЩИК: Узнай, какие карты действий лежат на руке у цели.", "БЕЗУМИЕ: Игрок меняет своего персонажа на персонажа соседа.", "ПЛАТЕЖКА: Заставь игрока отдать тебе карту действия.", "КАРА БОЖЬЯ: Игрок с фактом 'Зэк' или 'Убийца' уходит сразу.", "ОБЩАК: Собери по одному предмету у всех и раздай поровну.", "РЕСТАРТ: Игра начинается заново с этого момента.", "КОЗЕЛ ОТПУЩЕНИЯ: Выбери игрока, за которого будут все голосовать.", "ПРОВОКАТОР: Заставь двух игроков спорить, пока один не сдастся.", "ЭКСПЕРИМЕНТ: Игрок получает новую мутацию (случайный факт).", "ИНВАЛИДНОСТЬ: Сделай игрока хромым (минус к выживанию).", "ПОСЛЕДНЕЕ ЖЕЛАНИЕ: Перед изгнанием игрок меняет статы любому.", "САБОТАЖНИК: Испорти оборудование бункера (минус места).", "ДИКТАТОР: Ты сам выбираешь, кто уйдет, но отдаешь весь багаж.", "МИРОТВОРЕЦ: В этот круг никто не может быть изгнан.", "МАГНАТ: У кого больше всего багажа, тот получает +2 голоса.", "ЗЕРКАЛО МЕРТВЕЦА: Скопируй статы уже изгнанного игрока.", "СЛЕПОЕ ПРАВОСУДИЕ: Изгоняем того, на кого укажет кубик.", "КУРЬЕР: Достань любой предмет из колоды багажа.", "ФЕЙК-НЬЮС: Напиши любой факт игроку (теперь это правда).", "ГРЯЗНЫЙ ГАРРИ: Угрожай игроку, чтобы он промолчал.", "КРИЗИС: Половина игроков должна сбросить по 2 предмета.", "СПАСАТЕЛЬНЫЙ КРУГ: Передай свой иммунитет другому.", "ТОКСИК: Твои слова наносят урон (игрок получает стресс/фобию).", "ОШИБКА ВРАЧА: Хотели вылечить, но сделали хуже (здоровье вниз).", "ГЕНЕТИЧЕСКИЙ СБОЙ: Репродукция игрока падает до нуля.", "ЭЙФОРИЯ: Все болезни игрока временно не считаются.", "ОТКАТ: Верни карту действия в колоду и возьми новую.", "СНАЙПЕР: Удали предмет из рук игрока прямо во время его речи.", "ВНЕЗАПНАЯ СМЕРТЬ: Если у игрока 3+ болезни, он вылетает.", "БЛАГОТВОРИТЕЛЬНОСТЬ: Раздай свои болезни другим поровну.", "ФИНАЛЬНЫЙ РЫВОК: В конце игры ты можешь заменить 1 характеристику."];        
        const MY_BUNKER_EVENTS = {
        SURVIVOR: [ { t: "КРИТИЧЕСКИЙ СБОЙ ГЕНЕРАТОРА", d: "Реактор барахлит. У нас есть 3 минуты, чтобы придумать решение, иначе свет отрубится навсегда!", img: "https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=800" }, { t: "РАНЕНЫЙ СТРАННИК", d: "У входа человек с кейсом. Он просит убежища и бинты. Пускаем или гоним в шею? У нас 3 минуты на решение.", img: "https://images.unsplash.com/photo-1536440136628-849c177e76a1?w=800" }, { t: "ВИРУС В ВЕНТИЛЯЦИИ", d: "Датчики фиксируют биологическую угрозу. Как будем очищать воздух? 3 минуты на обдумывание в чате!", img: "https://images.unsplash.com/photo-1523438097201-512ae7d59c44?w=800" } ]
        };
        
        const BOT_NAMES_M = ["Александр", "Дмитрий", "Максим", "Сергей", "Андрей", "Алексей", "Артем", "Илья", "Кирилл", "Михаил", "Никита", "Матвей", "Роман", "Егор", "Арсений", "Иван", "Денис", "Евгений", "Даниил", "Тимофей"];
        const BOT_NAMES_F = ["Анна", "Мария", "Елена", "Дарья", "Алина", "Ирина", "Екатерина", "Анастасия", "Наталья", "Виктория", "Полина", "София", "Елизавета", "Ксения", "Валерия", "Александра", "Ольга", "Юлия", "Маргарита", "Алиса"];
        const SURNAMES = ["Иванов", "Смирнов", "Кузнецов", "Попов", "Соколов", "Лебедев", "Козлов", "Новиков", "Морозов", "Петров", "Волков", "Соловьев", "Васильев", "Зайцев", "Павлов", "Семенов", "Голубев", "Виноградов", "Богданов", "Воробьев"];

        const LISTS = { 
            sex: ["МУЖ", "ЖЕН"],
            prof: ["Хирург-трансплантолог", "Инженер ядерных реакторов", "Шеф-повар", "Пилот боевого дрона", "Кибер-криминалист", "Астробиолог", "Психолог-манипулятор", "Гробовщик", "Учитель выживания", "Дипломат ООН", "Физик", "Хакер", "Снайпер", "Фермер-генетик", "Архитектор бункеров", "Ветеринар хищников", "Морской биолог", "Священник-экзорцист", "Инженер-робототехник", "Пилот гражданской авиации", "Токсиколог", "Оператор РЛС", "Горноспасатель", "Криптограф", "Эпидемиолог", "Профессиональный наемник", "Геолог-разведчик", "Метеоролог", "Крановщик", "Сапер", "Лесник", "Фармацевт", "Инкассатор", "Авиаконструктор", "Судмедэксперт", "Сварщик-подводник", "Системный администратор", "Следователь по особо важным", "Промышленный альпинист", "Биохимик", "Машинист поезда", "Картограф", "Диетолог", "Парамедик", "Специалист по связям с общественностью", "Профайлер", "Океанограф", "Переводчик-синхронист", "Электрик высокого разряда", "Учитель химии", "Пожарный-парашютист", "Дрессировщик служебных собак", "Логист", "Техник по обслуживанию лифтов", "Кузнец", "Юрист по международному праву", "Космонавт-исследователь", "Лаборант химического анализа", "Реставратор оружия", "Механик тяжелой техники", "Капитан дальнего плавания", "Гидролог", "Бурильщик скважин", "Военный переводчик", "Эколог", "Физиотерапевт", "Программист ИИ", "Плотник", "Архивариус", "Журналист-расследователь", "Инженер-строитель мостов", "Каскадер", "Оружейный мастер", "Охотовед", "Радиотехник", "Травматолог", "Бальзамировщик", "Оператор АЭС", "Слесарь-инструментальщик", "Моторист", "Пчеловод", "Кинолог", "Логопед", "Сомелье", "Ювелир", "Охранник ЧОП", "Матрос", "Таксист со стажем", "Кладовщик", "Агроном", "Зоопсихолог", "Оптик", "Телохранитель", "Стеклодув", "Энергетик", "Эксперт-искусствовед", "Спелеолог", "Коллектор", "Криминалист-баллистик", "Директор морга"],         
            health: ["Тяжелая астма", "Диабет 1 типа", "Лучевая болезнь", "Бессонница", "Слепота", "Глухота", "Мигрени", "Артрит", "Сколиоз", "Анемия", "Идеальное здоровье", "Железный иммунитет", "Крепкое сердце", "Дальтонизм", "Гастрит", "Порок сердца", "Ожирение 2 степени", "Истощение", "Аллергия на пыльцу", "Эпилепсия", "Психосоматический кашель", "Почечная недостаточность", "Плохое зрение (-5)", "Хронический бронхит", "Нарколепсия", "Дрожь в руках (тремор)", "Панические атаки", "Болезнь Крона", "Заикание", "Хроническая усталость", "Хромота на левую ногу", "Отсутствие фаланги пальца", "Чувствительная кожа", "Плохая свертываемость крови", "Грыжа позвоночника", "Тугоухость", "Язва желудка", "Аллергия на арахис", "Ипохондрия", "Варикоз", "Остеопороз", "Хронический гайморит", "Тахикардия", "Низкий болевой порог", "Гипертония", "Повышенный сахар", "Дефицит кальция", "Нарушение координации", "Аллергия на лактозу", "Амнезия частичная", "Псориаз", "Синдром раздраженного кишечника", "Невралгия", "Потеря обоняния", "Гемофилия", "Рассеянный склероз", "Конъюнктивит хронический", "Плоскостопие 3 степени", "Вегетососудистая дистония", "Метеозависимость", "Кариес запущенный", "Изжога", "Цистит", "Дерматит", "Ревматизм", "Синдром Туретта (легкий)", "Высокий метаболизм", "Гибкие суставы", "Острый слух", "Ночное зрение (хорошее)", "Быстрая регенерация", "Слабый вестибулярный аппарат", "Фотофобия (светобоязнь)", "Хрупкие кости", "Одышка", "Желчнокаменная болезнь", "Туберкулез (ремиссия)", "Аллергия на кошек", "Депрессия клиническая", "Посттравматическое расстройство", "Повышенная потливость", "Мышечная дистрофия", "Ранняя стадия Паркинсона", "Холестерин выше нормы", "Шум в ушах", "Ожоги на 20% тела", "Старая травма колена", "Глаукома начальная", "Повышенная тревожность", "Авитаминоз", "Чувствительность к глютену", "Искривление носовой перегородки", "Мышечные судороги", "Бесплодие", "Камни в почках", "Непереносимость жары", "Переохлаждение", "Морская болезнь", "Золотистый стафилококк", "Здоровый атлет", "Крепкие зубы"],
            bag: ["Аптечка полная", "Охотничий нож", "Фонарик LED", "Рация", "Счётчик Гейгера", "Запас еды", "Семена", "Топор стальной", "Бинокль", "Зажигалка Zippo", "Компас", "Карта области", "Спальный мешок", "Складная пила", "Котелок алюминиевый", "Фляга с водой", "Рулон скотча (армированный)", "Набор рыболовных крючков", "Солнечная панель (мини)", "Мультитул", "Паракорд (15 метров)", "Противогаз", "Огниво", "Бронежилет 2 класса", "Монтировка", "Сухое горючее", "Фильтр для воды", "Набор отмычек", "Сигнальная ракета", "Термос", "Газовая горелка", "Тент непромокаемый", "Газовая маска", "Лопата саперная", "Моток проволоки", "Пакеты для мусора (крепкие)", "Мыло и антисептик", "Спички охотничьи", "Фонарь налобный", "Кастет", "Перцовый баллончик", "Резиновые сапоги", "Арбалет с 3 болтами", "Запасные батарейки", "Набор иголок и ниток", "Светоотражающий жилет", "Свисток спасательный", "Ножовка по металлу", "Бутылка водки (для дезинфекции)", "Блокнот и карандаш", "Зеркальце сигнальное", "Стальные карабины", "Веревка альпинистская", "Санитайзер", "Молоток", "Стамеска", "Гвозди (полкило)", "Дождевик", "Запасная одежда", "Увеличительное стекло", "Канистра пустая", "Шланг резиновый", "Мегафон", "Катушка лески", "Набор надфилей", "Респиратор", "Резиновые перчатки", "Замок навесной", "Пневматический пистолет", "Рогатка профессиональная", "Металлическая кружка", "Йод и зеленка", "Бинты стерильные", "Набор ключей (гаечных)", "Изолента синяя", "Магниевый стержень", "Очки защитные", "Салфетки влажные", "Кожаный ремень", "Набор сверл", "Рулетка 5м", "Отвертка крестовая", "Газовый ключ", "Шило", "Складной стакан", "Герметичный пакет", "Сухой паек МЧС", "Термоодеяло", "Мел", "Гвоздодер", "Баллончик с краской", "Цепь металлическая", "Наждачная бумага", "Пассатижи", "Налобная линза", "Фляжка с коньяком", "Мешочек соли", "Пачка сахара", "Кофе растворимый", "Пустой рюкзак"],
            facts: ["Знает код от сейфа", "Мастер рукопашного боя", "Бывший агент", "Гениальный математик", "Служил в точках", "Умеет чинить всё", "Бывший зэк", "Патологический лжец", "Психопат", "Клептоман", "Умеет читать по губам", "Владеет гипнозом", "Бывший сапер", "Знает азбуку Морзе", "Мастер взлома замков", "Скрывается от интерпола", "Бывший дегустатор ядов", "Умеет водить вертолет", "Сын/дочь миллиардера", "Помнит всё (гипертимезия)", "Мастер маскировки", "Бывший работник морга", "Знает 7 языков", "Умеет шить раны", "Бывший сектант", "Служил в иностранном легионе", "Мастер игры в покер", "Умеет метать ножи", "Профессиональный альпинист", "Бывший телохранитель", "Знает устройство АЭС", "Умеет распознавать ложь", "Бывший двойной агент", "Мастер социальной инженерии", "Умеет выживать в пустыне", "Бывший пилот-испытатель", "Знает карту подземных коммуникаций", "Бывший охотник на людей", "Мастер ядов и антидотов", "Умеет задерживать дыхание на 4 минуты", "Бывший инструктор по стрельбе", "Знает слабые точки на теле", "Бывший хакер-активист", "Умеет обращаться с лошадьми", "Бывший военный врач", "Мастер партизанской войны", "Знает расположение военных складов", "Бывший коллектор", "Умеет подделывать документы", "Бывший эксперт-криминалист", "Мастер бесшумного передвижения", "Знает все съедобные грибы", "Бывший разведчик", "Умеет управлять яхтой", "Бывший оперативник ФСБ", "Мастер стрельбы из лука", "Знает коды доступа к спутникам", "Бывший заложник", "Умеет дрессировать хищников", "Бывший инкассатор", "Мастер холодного оружия", "Знает рецепт термита", "Бывший физик-ядерщик", "Умеет предсказывать погоду", "Бывший картограф", "Мастер пыток", "Знает как вскрыть банкомат", "Бывший подводник", "Умеет лечить травами", "Бывший священник", "Мастер психологического давления", "Знает как собрать рацию из мусора", "Бывший гонщик", "Умеет ориентироваться по звездам", "Бывший киллер", "Мастер каллиграфии", "Знает где спрятаны архивы", "Бывший лаборант секретной базы", "Умеет делать самопалы", "Бывший десантник", "Мастер допроса", "Знает структуру правительства", "Бывший шпион-нелегал", "Умеет ловить рыбу голыми руками", "Бывший дипломат", "Мастер спорта по фехтованию", "Знает чертежи бункеров города", "Бывший лесничий", "Умеет взламывать умные дома", "Бывший патологоанатом", "Мастер по самодельному оружию", "Знает частоты спецслужб", "Бывший вор-домушник", "Умеет делать противогазы из подручных средств", "Бывший снайпер спецназа", "Мастер джиу-джитсу", "Знает уязвимости систем защиты", "Бывший спасатель", "Умеет добывать воду из воздуха", "Бывший военный переводчик", "Мастер по выживанию в лесу", "Знает как обмануть детектор лжи", "Бывший авиадиспетчер", "Умеет чинить двигатели", "Бывший судмедэксперт", "Мастер игры на скрипке", "Знает как сделать взрывчатку из химии", "Бывший повар в тюрьме", "Умеет читать следы животных", "Бывший член ОПГ", "Мастер по электронике", "Знает расположение очистных сооружений", "Бывший аналитик ГРУ", "Умеет обращаться со взрывчаткой", "Бывший стюард", "Мастер подледной ловли", "Знает все тайные ходы в метро", "Бывший пожарный", "Умеет шить одежду", "Бывший ветеринар", "Мастер по замкам и сейфам", "Знает формулу универсального антибиотика", "Бывший морпех", "Умеет водить фуру", "Бывший кибер-полицейский", "Мастер йоги", "Знает уязвимые места зданий", "Бывший каскадер", "Умеет охотиться с копьем", "Бывший библиотекарь секретного архива", "Мастер по установке ловушек", "Знает как взломать систему вентиляции", "Бывший механик танков", "Умеет добывать огонь трением", "Бывший радист", "Мастер спорта по боксу", "Знает как очистить воду радиации", "Бывший эколог", "Умеет управлять дронами", "Бывший инструктор по дайвингу", "Мастер ножевого боя", "Знает как обойти датчики движения", "Бывший метеоролог", "Умеет работать на токарном станке", "Бывший геолог", "Мастер гипнотического внушения", "Знает тайники контрабандистов", "Бывший надзиратель", "Умеет распознавать ядовитые пары", "Бывший профайлер", "Мастер кузнечного дела", "Знает частоту правительственной связи", "Бывший пограничник", "Умеет делать ловушки на людей", "Бывший оптик", "Мастер спортивного ориентирования", "Знает секреты фармацевтики", "Бывший водитель скорой помощи", "Умеет вскрывать электронные замки", "Бывший взрывотехник", "Мастер рукопашного боя Крав-мага", "Знает точки сброса припасов", "Бывший сотрудник ЦРУ", "Умеет обходиться без сна 3 дня", "Бывший агроном", "Мастер игры в го", "Знает как сделать порох", "Бывший электрик", "Умеет водить любой спецтранспорт", "Бывший системный администратор МВД", "Мастер маскировки на местности", "Знает коды отмены ракет", "Бывший психиатр", "Умеет разделывать любую тушу", "Бывший штурман", "Мастер скоростной стрельбы", "Знает где находятся запасы семян", "Бывший зоолог", "Умеет общаться жестами", "Бывший спец по прослушке", "Мастер по изготовлению брони", "Знает лазейки в законах", "Бывший следователь", "Умеет определять направление ветра по звуку", "Бывший фотограф-шпион", "Мастер по ремонту раций", "Знает где лежат ключи от города", "Бывший донор крови", "Умеет предсказывать землетрясения", "Бывший дрессировщик собак", "Мастер по скрытому ношению оружия", "Знает как сделать фильтр для воздуха", "Бывший топограф", "Умеет строить плоты", "Бывший гроссмейстер", "Мастер по созданию помех", "Знает тайные сигналы банд", "Бывший врач-инфекционист", "Умеет прыгать с парашютом", "Бывший оружейный мастер", "Мастер завязывания морских узлов", "Знает как отключить сигнализацию", "Бывший связист", "Умеет находить воду под землей", "Бывший инспектор ГИБДД", "Мастер по работе с металлом", "Знает как выжить при 50 градусах", "Бывший моряк-наемник", "Умеет делать антисептик", "Обладает иммунитетом к змеиному яду"],
            hobby: ["Стрельба", "Бокс", "Шахматы", "Йога", "Паркур", "Дайвинг", "Садоводство", "Вязание", "Рыбалка", "Охота", "Рисование", "Кулинария", "Коллекционирование марок", "Моделирование кораблей", "Бег на длинные дистанции", "Фехтование", "Скалолазание", "Чтение классики", "Фотография", "Игра на гитаре", "Резьба по дереву", "Астрономия", "Велоспорт", "Пение в хоре", "Настольные игры", "Карточные фокусы", "Пчеловодство", "Походы", "Шитье одежды", "Оригами", "Каллиграфия", "Танцы (латино)", "Ремонт старых часов", "Метание диска", "Гимнастика", "Тяжелая атлетика", "Наблюдение за птицами", "Изготовление свечей", "Нумизматика (монеты)", "Мыловарение", "Фехтование на мечах", "Изучение мертвых языков", "Мотоциклы", "Пилотирование", "Составление кроссвордов", "Покер", "Медитация", "Спелеология", "Реставрация мебели", "Скрапбукинг", "Плетение из лозы", "Гончарное дело", "Моделирование одежды", "Киберспорт", "Театр", "Стрельба из лука", "Плавание", "Дизайн интерьеров", "Собирание пазлов", "Вышивание крестиком", "Резьба по кости", "Бодибилдинг", "Укрощение змей", "Парфюмерия", "Игра на фортепиано", "Декупаж", "Пирография (выжигание)", "Ландшафтный дизайн", "Пивоварение", "Виноделие", "Макраме", "Бои без правил", "Регби", "Лыжи", "Сноубординг", "Серфинг", "Прыжки с парашютом", "Коллекционирование винила", "Уличное граффити", "Моделирование самолетов", "Энтомология (насекомые)", "Палеонтология (ископаемые)", "Книжный клуб", "Резьба по камню", "Стрит-арт", "Блогинг", "Фольклористика", "Изучение боевых искусств", "Ролики", "Скейтбординг", "Волейбол", "Баскетбол", "Теннис", "Гольф", "Бильярд", "Кегельбан", "Составление гербариев", "Мозаика", "Витражное искусство", "Сон"],
            phob: ["Темнота", "Высота", "Пауки", "Кровь", "Огонь", "Глубина", "Микробы", "Змеи", "Врачи", "Толпа", "Замкнутые пространства", "Клоуны", "Громкие звуки", "Острые предметы", "Вода", "Одиночество", "Смерть", "Насекомые", "Птицы", "Собаки", "Стоматологи", "Старение", "Болезни", "Полеты на самолете", "Открытые пространства", "Публичные выступления", "Технологии (ИИ)", "Грызуны", "Гром и молния", "Призраки", "Зеркала", "Куклы", "Микрофоны", "Грязные руки", "Потеря памяти", "Пчелы и осы", "Больницы", "Химикаты", "Радиация", "Роботы", "Зубная боль", "Иголки (уколы)", "Ответственность", "Неудача", "Критика", "Грязь", "Лес", "Туман", "Гниль", "Скорость", "Лифты", "Мертвые тела", "Кладбища", "Неизвестность", "Галлюцинации", "Потеря контроля", "Отражения", "Боль", "Слабость", "Предательство", "Темная вода", "Подвалы", "Чердаки", "Старые дома", "Глубокий снег", "Песок (зыбучие пески)", "Ветер (ураганы)", "Дождь", "Холод", "Жара", "Электричество", "Сон (кошмары)", "Тишина", "Смех (чужой)", "Наблюдение за собой", "Прикосновения", "Маски", "Большие предметы", "Крошечные отверстия (трипофобия)", "Поезда", "Мосты", "Тоннели", "Подводные лодки", "Оружие", "Полиция", "Суд", "Тюрьма", "Насилие", "Гнев", "Слезы", "Психиатрические лечебницы", "Лекарства", "Взрывы", "Пыль", "Кошки", "Большие города", "Пустые улицы", "Старость", "Будущее", "Сама жизнь"],
            fert: ["ПЛОДОВИТ (ИДЕАЛЬНО)", "БЕСПЛОДЕН", "ГЕНЕТИЧЕСКАЯ МУТАЦИЯ ДНК", "БОЛЕЛ ЗППП (50/50)", "СУПЕР-ГЕНЕТИКА"],
        };
        
        const LABELS = {bio: 'БИО', prof: 'Профессию', health: 'Здоровье', bag: 'Багаж', hobby: 'Хобби', phob: 'Фобию', fert: 'Репродукцию', f1: 'Факт 1', f2: 'Факт 2'};

        const { useState, useEffect, useRef } = React;

        // БЕЗОПАСНОЕ ПОЛУЧЕНИЕ ГОЛОСОВ ДЛЯ ЗАЩИТЫ ОТ КРАШЕЙ РЕАКТА
        const getVotes = (p) => {
            if (!p || !p.votedBy) return [];
            if (Array.isArray(p.votedBy)) return p.votedBy;
            if (typeof p.votedBy === 'object') return Object.values(p.votedBy);
            return [];
        };

        function App() {
            
            // === ПЕРЕМЕННЫЕ СОСТОЯНИЯ ===
            const [gameState, setGameState] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showOwnerPanel, setShowOwnerPanel] = useState(false);
            const [showEndModal, setShowEndModal] = useState(false);
            const [targetUserId, setTargetUserId] = useState("");
            const [targetRole, setTargetRole] = useState("admin");
            const [pCount, setPCount] = useState(8);
            const [user, setUser] = useState(null);
            const [role, setRole] = useState('player'); 
            const [isBanned, setIsBanned] = useState(false);
            const [userName, setUserName] = useState("Игрок");
            const [userAvatar, setUserAvatar] = useState(""); 
            const [messages, setMessages] = useState([]);
            const [msgInput, setMsgInput] = useState("");
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [isMuted, setIsMuted] = useState(false);
            const [authMode, setAuthMode] = useState('login'); 
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [regName, setRegName] = useState("");
            const [regAvatar, setRegAvatar] = useState(`https://i.pravatar.cc/300?u=${Math.random()}`);
            const [userId, setUserId] = useState(null);
            const [userStats, setUserStats] = useState(null);
            const [currentView, setCurrentView] = useState('game'); 
            const [viewProfile, setViewProfile] = useState(null);
            const [activeActionModal, setActiveActionModal] = useState(null);
            const [votingModal, setVotingModal] = useState(false);
            const gameStateRef = useRef(null);
            useEffect(() => { gameStateRef.current = gameState; }, [gameState]);

            const [sysAlert, setSysAlert] = useState(null); 
            const [punishModal, setPunishModal] = useState(null); 
            const [punishReason, setPunishReason] = useState("");
            const [staffList, setStaffList] = useState([]);
            const [showStaffPanel, setShowStaffPanel] = useState(false);
            const [appealText, setAppealText] = useState("");

            // === СЛУШАТЕЛИ FIREBASE ===
            useEffect(() => {
                db.ref('game').on('value', snap => setGameState(snap.val()));

                auth.onAuthStateChanged(u => { 
                    if(u) {
                        setUser(u); 
                        db.ref(`users/${u.uid}`).on('value', snap => {
                            const val = snap.val();
                            if (val) {
                                if (val.isBanned || (val.banUntil && val.banUntil > Date.now())) { 
                                    setIsBanned(true); setIsAdmin(false); 
                                }
                                else {
                                    if (val.banUntil && val.banUntil <= Date.now()) {
                                        db.ref(`users/${u.uid}/isBanned`).set(false);
                                        db.ref(`users/${u.uid}/banUntil`).set(null);
                                    }
                                    
                                    setIsBanned(false);
                                    setRole(val.role || 'player');
                                    setUserName(val.name || val.Name || "Объект");
                                    setUserAvatar(val.avatar || val.Avatar || ""); 
                                    
                                    if (!val.userId) {
                                        db.ref('system/lastId').transaction(id => (id || 0) + 1, (err, comm, snapId) => {
                                            const newId = snapId.val();
                                            db.ref(`users/${u.uid}/userId`).set(newId);
                                            setUserId(newId);
                                        });
                                    } else {
                                        setUserId(val.userId);
                                    }

                                    setUserStats(val.stats || { games: 0, survived: 0 });
                                    setIsMuted(val.isMuted || false);
                                }
                            } else {
                                db.ref(`users/${u.uid}`).set({ name: "Новый Игрок", role: "player", isBanned: false });
                            }
                        });
                    } else {
                        setUser(null); 
                    }
                });
            }, []);
            
            useEffect(() => {
                db.ref('chat').limitToLast(50).on('value', snap => {
                    const data = snap.val();
                    setMessages(data ? Object.entries(data).map(([id, msg]) => ({id, ...msg})) : []);
                });
            }, []);

            // ЗАГРУЗКА СПИСКА АДМИНОВ
            useEffect(() => {
                if (role === 'owner' || role === 'curator') {
                    db.ref('users').on('value', snap => {
                        const data = snap.val();
                        if(data) {
                            setStaffList(Object.entries(data).map(([uid, u]) => ({uid, ...u})).filter(u => ['admin', 'host', 'curator', 'tester'].includes(u.role) && u.uid !== user?.uid));
                        }
                    });
                }
            }, [role, user?.uid]);

            // === 🤖 АБСОЛЮТНЫЙ ИИ-ВЕДУЩИЙ (БЕЗ ЗАВИСАНИЙ И КРАШЕЙ) ===
            const seatedPlayers = gameState?.players?.filter(p => p.uid) || [];
            
            // СТРОГАЯ ЗАЩИТА: Мозг бота находится только у ОДНОГО человека (первый реальный игрок, либо владелец)
            const amIFirstSeated = seatedPlayers.length > 0 && seatedPlayers[0].uid === user?.uid;
            const amIOwnerWithEmptyLobby = seatedPlayers.length === 0 && role === 'owner';
            const isAiRunner = amIFirstSeated || amIOwnerWithEmptyLobby;            
            
            const botSay = (text) => { db.ref('chat').push({ uid: 'ai_bot', name: 'Бункер Игра 🤖', role: 'host', text, time: Date.now() }); playSfx(sfx.event); };

            // 1. УНИВЕРСАЛЬНЫЙ ТАЙМЕР
            useEffect(() => {
                if (!isAiRunner || !gameState?.active) return;
                
                const timer = setInterval(() => { 
                    const g = gameStateRef.current;
                    if (!g || !g.active || g.locked) return; 

                    let updates = { time: (g.time || 0) + 1 };
                    
                    if (g.turnTime > 0) updates.turnTime = g.turnTime - 1;
                    if (g.discussionTime > 0) updates.discussionTime = g.discussionTime - 1;
                    if (g.votingTime > 0) updates.votingTime = g.votingTime - 1;
                    if (g.eventTime > 0) updates.eventTime = g.eventTime - 1;
                    
                    db.ref('game').update(updates);
                }, 1000);
                
                return () => clearInterval(timer);
            }, [isAiRunner, gameState?.active]);

            // 2. ИГРОВОЙ ЦИКЛ (ФАЗЫ ИГРЫ)
            useEffect(() => {
                if (!isAiRunner || !gameState?.active || gameState?.locked) return;
                const g = gameState;

                const lockBot = () => db.ref('game/locked').set(true);
                const unlockBot = () => db.ref('game/locked').set(false);

                // --- ФАЗА: ВЫСТУПЛЕНИЯ ---
                if (g.phase === 'speaking') {
                    const currentP = g.players.find(p => p.id === g.speakerId);
                    
                    // ХОД БОТА (NPC)
                    if (currentP && !currentP.uid && g.turnTime === -1) {
                        lockBot().then(() => {
                            setTimeout(() => {
                                const botP = gameStateRef.current.players.find(p => p.id === gameStateRef.current.speakerId);
                                if (botP) {
                                    const hiddenStats = ['bio', 'prof', 'health', 'bag', 'hobby', 'phob', 'fert', 'f1', 'f2'].filter(f => f === 'bio' ? !botP.revealed?.sex : !botP.revealed?.[f]);
                                    if (hiddenStats.length > 0) {
                                        const stat = hiddenStats[Math.floor(Math.random() * hiddenStats.length)];
                                        if(stat === 'bio') { 
                                            db.ref(`game/players/${botP.id - 1}/revealed/sex`).set(true); 
                                            db.ref(`game/players/${botP.id - 1}/revealed/age`).set(true); 
                                        } else { 
                                            db.ref(`game/players/${botP.id - 1}/revealed/${stat}`).set(true); 
                                        }
                                        const valText = stat === 'bio' ? `${botP.sex}, ${botP.age} лет` : botP[stat];
                                        botSay(`💅 Бот №${botP.id} (${botP.name}) вскрывает: ${LABELS[stat] || stat} — [${valText}]`);
                                    }
                                }
                                db.ref('game').update({ turnTime: 5, locked: false }); // Боту 5 секунд на показ
                            }, 2500);
                        });
                        return;
                    }

                    // Передача слова дальше
                    if (g.turnTime === 0 && g.speakerId !== null) {
                        lockBot().then(() => {
                            db.ref('game/turnTime').set(-2).then(() => {
                                setTimeout(() => {
                                    const nextP = gameStateRef.current.players.find(p => p.id > gameStateRef.current.speakerId && !p.isExiled);
                                    if (nextP) {
                                        db.ref('game').update({ speakerId: nextP.id, turnTime: -1, locked: false });
                                        botSay(`💈 Очередь объекта №${nextP.id} (${nextP.name}).`);
                                    } else {
                                        // Все высказались -> ОБСУЖДЕНИЕ
                                        db.ref('game').update({ speakerId: null, phase: 'discussion', discussionTime: 120, locked: false });
                                        botSay(`🗣 Все характеристики вскрыты! Начинается общее обсуждение.\nУ вас 2 минуты. Договоритесь, кого выгнать!`);
                                    }
                                }, 1000);
                            });
                        });
                        return;
                    }
                }

                // --- ФАЗА: ИВЕНТ (Событие) ---
                if (g.phase === 'event') {
                    if (g.eventTime === 60 && !window.evWarn60s) {
                        window.evWarn60s = true;
                        botSay(`⏳ Осталась 1 минута на решение проблемы! Предлагайте варианты в чат!`);
                    }
                    if (g.eventTime === 0) {
                        lockBot().then(() => {
                            window.evWarn60s = false;
                            const success = Math.random() > 0.4; // 60% шанс успеха
                            if (success) {
                                botSay(`✅ Вы успешно справились с событием! Вы как-то разрулили этот треш. Бункер в норме.`);
                            } else {
                                const alive = g.players.filter(p => !p.isExiled);
                                const victim = alive[Math.floor(Math.random() * alive.length)];
                                db.ref(`game/players/${victim.id - 1}/health`).set("Стресс и паранойя");
                                botSay(`❌ Ну вы и выдали кринж... Решение не сработало.\nОбъект №${victim.id} получает травму на нервной почве.`);
                            }
                            
                            db.ref('game').update({
                                phase: 'speaking',
                                eventTime: -1,
                                currentEvent: null,
                                turnTime: -1,
                                locked: false
                            }).then(() => {
                                botSay(`💈 Возвращаемся к игре! Очередь объекта №${g.speakerId}.`);
                            });
                        });
                        return;
                    }
                }

                // --- ФАЗА: ОБСУЖДЕНИЕ ---
                if (g.phase === 'discussion') {
                    if (g.discussionTime === 30 && !window.discWarn30s) { 
                        window.discWarn30s = true; 
                        botSay(`⏳ До конца обсуждения 30 секунд! Заканчиваем срач!`); 
                    }
                    if (g.discussionTime === 0) {
                        lockBot().then(() => {
                            window.discWarn30s = false;
                            db.ref('game').update({ phase: 'voting', votingTime: 30, discussionTime: -1, locked: false }).then(() => {
                                botSay(`🔴 Обсуждение завершено! Начинается ГОЛОСОВАНИЕ.\nУ вас 30 секунд. Жмите красную кнопку!`);
                            });
                        });
                        return;
                    }
                }

                // --- ФАЗА: ГОЛОСОВАНИЕ И ИТОГИ ---
                if (g.phase === 'voting') {
                    if (g.votingTime === 10 && !window.voteWarn10s) { 
                        window.voteWarn10s = true; 
                        botSay(`⏳ До конца голосования 10 секунд! Выбирайте цель!`); 
                    }

                    const aliveRealCount = g.players.filter(p => !p.isExiled && p.uid).length;
                    const totalVotes = g.players.reduce((sum, p) => sum + getVotes(p).length, 0);
                    
                    // Вышло время ИЛИ проголосовали все живые реальные игроки
                    if (g.votingTime === 0 || (aliveRealCount > 0 && totalVotes >= aliveRealCount)) {
                        lockBot().then(() => {
                            window.voteWarn10s = false;
                            
                            db.ref('game/votingTime').set(-2).then(() => {
                                const currentG = gameStateRef.current;
                                let maxV = 0; let targetKick = null; let tie = false;
                                
                                currentG.players.forEach(p => {
                                    if (p.isExiled) return;
                                    const vCount = getVotes(p).length;
                                    if (vCount > maxV) { maxV = vCount; targetKick = p; tie = false; }
                                    else if (vCount === maxV && maxV > 0) tie = true;
                                });

                                // Безопасная очистка голосов
                                let updates = {}; 
                                currentG.players.forEach((p, i) => { updates[`players/${i}/votedBy`] = ""; });

                                if (targetKick && !tie && maxV > 0) {
                                    const kickIdx = currentG.players.findIndex(p => p.id === targetKick.id);
                                    updates[`players/${kickIdx}/isExiled`] = true;
                                }

                                // ПРИМЕНЯЕМ РЕЗУЛЬТАТЫ ГОЛОСОВАНИЯ
                                db.ref('game').update(updates).then(() => {
                                    if (maxV === 0 || tie) {
                                        botSay(maxV === 0 ? `🌜 Голосование пропущено. В этом раунде никого не выгоняем.` : `⚖️ Ничья по голосам! Никто не уходит.`);
                                    } else {
                                        botSay(`🚪 БУНКЕР СДЕЛАЛ ВЫБОР! Изгнан №${targetKick.id} (${targetKick.name})! У него было ${maxV} голосов.`);
                                    }

                                    setTimeout(() => {
                                        const freshG = gameStateRef.current;
                                        const alive = freshG.players.filter(p => !p.isExiled);
                                        const targetA = freshG.targetAlive;
                                        
                                        if (alive.length <= targetA) {
                                            // ФИНАЛ ИГРЫ
                                            let tot = 0;
                                            alive.forEach(p => {
                                                let sc = 50;
                                                if (p.revealed?.health || !p.uid) sc += p.health.includes("Идеал")||p.health.includes("Железный") ? 30 : p.health.includes("астма")||p.health.includes("диабет") ? -30 : 0;
                                                if (p.revealed?.fert || !p.uid) sc += p.fert.includes("ПЛОДОВИТ") ? 20 : p.fert.includes("БЕСПЛОДЕН") ? -40 : 0;
                                                tot += Math.max(0, Math.min(100, sc));
                                            });
                                            const avgChance = alive.length ? Math.round(tot / alive.length) : 0;
                                            const isWin = avgChance >= 49;
                                            
                                            botSay(`⚠️ НАЧИНАЕТСЯ ФИНАЛЬНОЕ ИСПЫТАНИЕ ⚠️\n\n🏆 СОСТАВ БУНКЕРА (${alive.length}/${targetA})\n📊 Шанс выживания группы: ${avgChance}%.\n\n${isWin ? "🎉 ПОБЕДА! Бункер успешно заселен." : "💀 ПОРАЖЕНИЕ. С таким генофондом вы обречены."}`);
                                            
                                            freshG.players.forEach(p => {
                                                if (p.uid) {
                                                    db.ref(`users/${p.uid}/stats`).once('value').then(s => {
                                                        const stats = s.val() || { games: 0, survived: 0 };
                                                        db.ref(`users/${p.uid}/stats`).set({ games: stats.games + 1, survived: (!p.isExiled && isWin) ? stats.survived + 1 : stats.survived });
                                                    });
                                                }
                                            });
                                            db.ref('game').update({ active: false, locked: false });
                                        } else {
                                            // НОВЫЙ РАУНД / ИВЕНТ
                                            const nextRound = (freshG.round || 1) + 1;
                                            
                                            if (nextRound === 2 && !freshG.eventDone) {
                                                const ev = MY_BUNKER_EVENTS.SURVIVOR[Math.floor(Math.random() * MY_BUNKER_EVENTS.SURVIVOR.length)];
                                                db.ref('game').update({
                                                    phase: 'event',
                                                    currentEvent: ev,
                                                    eventTime: 180, // 3 минуты на решение
                                                    eventDone: true,
                                                    speakerId: alive[0].id,
                                                    round: nextRound,
                                                    locked: false
                                                });
                                                botSay(`✨ ОПА! У нас тут проблемка подъехала!\n${ev.t}\n${ev.d}\n\n💬 У вас 3 минуты, чтобы обсудить это в чате и выдать гениальное решение! Админ может прописать "скип".`);
                                            } else {
                                                // Обычный раунд
                                                db.ref('game').update({ phase: 'speaking', round: nextRound, speakerId: alive[0].id, turnTime: -1, locked: false });
                                                botSay(`💈 Раунд ${nextRound} стартует!\nОчередь объекта №${alive[0].id}.`);
                                            }
                                        }
                                    }, 5000);
                                });
                            });
                        });
                        return;
                    }
                }
            }, [gameState?.turnTime, gameState?.discussionTime, gameState?.votingTime, gameState?.eventTime, gameState?.phase, gameState?.active, isAiRunner]);

            // 3. ЧАТ-КОМАНДЫ
            useEffect(() => {
                if (!isAiRunner) return;
                
                if (!gameState?.active && gameState?.phase === 'waiting' && seatedPlayers.length === parseInt(pCount) && parseInt(pCount) > 0) {
                    db.ref('game').update({ active: true, phase: 'speaking', speakerId: seatedPlayers[0].id, turnTime: -1 });
                    botSay(`🔥 Лобби заполнено! Стартуем, краши! Микрофон у №${seatedPlayers[0].id}.`);
                }

                const chatRef = db.ref('chat').limitToLast(1);
                const listener = chatRef.on('child_added', snap => {
                    const msg = snap.val();
                    if (!msg || msg.uid === 'ai_bot' || msg.time < Date.now() - 3000) return;
                    const text = msg.text.toLowerCase();

                    if (text === '!старт' && ['owner', 'admin', 'host', 'player', 'tester'].includes(msg.role) && !gameStateRef.current?.active) {
                        let pList = "";
                        gameStateRef.current.players.forEach(p => { pList += `№${p.id}. ${p.name || "NPC Бот"} (Пол — ${p.sex})\n`; });
                        botSay(`🚨 Катастрофа: ${gameStateRef.current.bunker?.d || "Неизвестно"}!\n🎉 Выиграть могут: ${gameStateRef.current.targetAlive} игрока!\n\n📇 Игроки:\n${pList}`);
                        
                        setTimeout(() => {
                            const firstA = gameStateRef.current.players.find(p => !p.isExiled);
                            if (firstA) {
                                db.ref('game').update({ active: true, phase: 'speaking', speakerId: firstA.id, turnTime: -1 });
                                botSay(`💈 Время раскрытия характеристик!\nОчередь объекта №${firstA.id}.`);
                            }
                        }, 4000);
                    }
                    if (['пас', 'я все', 'передаю'].includes(text) && msg.uid === gameStateRef.current.players.find(p => p.id === gameStateRef.current.speakerId)?.uid) {
                        db.ref('game/turnTime').set(0); botSay(`🎤 Речь завершена досрочно.`);
                    }
                    if (['скип', 'пропуск'].includes(text) && ['owner', 'admin', 'tester'].includes(msg.role)) {
                        if (gameStateRef.current?.phase === 'discussion') { db.ref('game/discussionTime').set(0); botSay(`⏭ Админ скипнул обсуждение.`); }
                        if (gameStateRef.current?.phase === 'event') { db.ref('game/eventTime').set(0); botSay(`⏭ Админ скипнул ивент.`); }
                    }
                    if (text === '!игра') {
                        botSay(`🛠 ИНСТРУКЦИЯ:\n1. !старт для запуска.\n2. Жмите на закрытую карту в своей анкете.\n3. Обсуждение 2 минуты.\n4. Голосование 30 сек.\n⚡ Команды: !старт, !игра, пас, скип.`);
                    }
                });
                return () => chatRef.off('child_added', listener);
            }, [isAiRunner, pCount]);
            
            // === ОСНОВНЫЕ ФУНКЦИИ ===
            const update = (path, val) => db.ref(`game/${path}`).set(val);
            
            const sendChat = () => {
                if (!msgInput.trim()) return;
                if (isMuted) return setSysAlert({ t: 'КАНАЛ ЗАКРЫТ', d: 'Вам выдан мут в чате. 🤐' });
                db.ref('chat').push({ uid: user?.uid, name: userName, role: role, text: msgInput, time: Date.now() });
                setMsgInput("");
            };

            const handleEndGame = () => {
                gameState.players.forEach(p => {
                    if (p.uid) {
                        db.ref(`users/${p.uid}/stats`).once('value', snap => {
                            const s = snap.val() || { games: 0, survived: 0 };
                            db.ref(`users/${p.uid}/stats`).set({
                                games: s.games + 1,
                                survived: p.isExiled ? s.survived : s.survived + 1
                            });
                        });
                    }
                });
                db.ref('game').set(null); 
                setShowEndModal(false);
            };

            // СИСТЕМА НАКАЗАНИЙ С ПРИЧИНОЙ
            const executePunishment = () => {
                if (!punishReason.trim()) return setSysAlert({ t: 'ОШИБКА', d: 'Укажите причину!' });
                const { uid, name, type } = punishModal;
                
                db.ref(`users/${uid}`).once('value', snap => {
                    const u = snap.val();
                    if(!u) return;

                    if (type === 'adminWarn') {
                        const w = (u.adminWarns || 0) + 1;
                        if (w >= 3) {
                            db.ref(`users/${uid}/role`).set('player');
                            db.ref(`users/${uid}/adminWarns`).set(0);
                            setSysAlert({ t: 'СНЯТИЕ С ДОЛЖНОСТИ', d: `Администратор ${name} снят с должности (3/3). Причина: ${punishReason}` });
                        } else {
                            db.ref(`users/${uid}/adminWarns`).set(w);
                            setSysAlert({ t: 'АДМИН ВАРН', d: `${name} получил выговор (${w}/3). Причина: ${punishReason}` });
                        }
                    } else if (type === 'warn') {
                        const w = (u.warns || 0) + 1;
                        if (w >= 3) {
                            db.ref(`users/${uid}/isBanned`).set(true);
                            db.ref(`users/${uid}/banUntil`).set(Date.now() + 3 * 24 * 60 * 60 * 1000);
                            db.ref(`users/${uid}/warns`).set(0);
                            setSysAlert({ t: 'БАН НА 3 ДНЯ', d: `Игрок ${name} забанен (3/3 варнов). Причина: ${punishReason}` });
                        } else {
                            db.ref(`users/${uid}/warns`).set(w);
                            setSysAlert({ t: 'ВАРН', d: `Игроку ${name} выдан варн (${w}/3). Причина: ${punishReason}` });
                        }
                    } else if (type === 'ban') {
                        const isB = !u.isBanned;
                        db.ref(`users/${uid}/isBanned`).set(isB);
                        db.ref(`users/${uid}/banUntil`).set(null);
                        setSysAlert({ t: isB ? 'БАН НАВСЕГДА' : 'РАЗБАН', d: `Игрок ${name} ${isB ? 'ЗАБАНЕН' : 'РАЗБАНЕН'}. Причина: ${punishReason}` });
                    }
                    
                    db.ref('chat').push({ uid: 'system', name: 'ПРАВОСУДИЕ', role: 'owner', text: `${name} получил наказание. Причина: ${punishReason}`, time: Date.now() });
                    
                    setPunishModal(null);
                    setPunishReason("");
                });
            };

            const assignRole = () => {
                if (!targetUserId) return;
                db.ref('users').orderByChild('userId').equalTo(Number(targetUserId)).once('value', snap => {
                    if (snap.exists()) {
                        const foundUid = Object.keys(snap.val())[0];
                        db.ref(`users/${foundUid}/role`).set(targetRole);
                        setSysAlert({ t: 'УСПЕШНО', d: `Роль ${targetRole} выдана игроку с ID ${targetUserId}!` });
                        setShowOwnerPanel(false);
                    } else { setSysAlert({ t: 'ОШИБКА', d: "Игрок с таким ID не найден!" }); }
                });
            };

            const deleteMsg = (msgId) => db.ref(`chat/${msgId}`).remove();
            
            const toggleMute = (targetUid, currentName) => {
                db.ref(`users/${targetUid}/isMuted`).once('value', snap => {
                    const currentMute = snap.val();
                    db.ref(`users/${targetUid}/isMuted`).set(!currentMute);
                    setSysAlert({ t: 'ЧАТ-КОНТРОЛЬ', d: `${currentName} теперь ${!currentMute ? 'В МУТЕ 🔇' : 'РАЗМУЧЕН 🔊'}` });
                });
            };

            const handleAuth = () => {
                const loginEmail = email.includes('@') ? email : `${email.toLowerCase()}@bunker.local`;
                if (authMode === 'login') {
                    auth.signInWithEmailAndPassword(loginEmail, password).catch(e => setSysAlert({ t: 'ОШИБКА ВХОДА', d: 'Неверный логин или пароль.' }));
                } else {
                    if(!regName) return setSysAlert({ t: 'ВНИМАНИЕ', d: 'Введите позывной!' });
                    if(email.length < 3) return setSysAlert({ t: 'ВНИМАНИЕ', d: 'Логин слишком короткий!' });
                    auth.createUserWithEmailAndPassword(loginEmail, password).then(cred => {
                        db.ref('system/lastId').transaction(id => (id || 0) + 1, (err, comm, snap) => {
                            db.ref(`users/${cred.user.uid}`).set({ name: regName, avatar: regAvatar, role: "player", isBanned: false, userId: snap.val() || 1, stats: { games: 0, survived: 0 } });
                        });
                    }).catch(e => setSysAlert({ t: 'ОШИБКА РЕГИСТРАЦИИ', d: 'Этот логин занят или пароль слишком простой (минимум 6 символов).' }));
                }
            };
            
            const handleAvatarUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setRegAvatar(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const roll = (t, currentAge = 50) => {
                if (t === 'age') return Math.floor(Math.random() * (99 - 18 + 1)) + 18; 
                if (t === 'years') return Math.floor(Math.random() * Math.max(1, currentAge - 18)) + 1;
                const list = LISTS[t === 'f1' || t === 'f2' ? 'facts' : t];
                return list[Math.floor(Math.random() * list.length)];
            };
            
            // === УМНЫЙ ДВИЖОК КАРТ ДЕЙСТВИЙ ===
            const executeCard = (pIdx, cTxt, pName, tIdx) => {
                const target = gameState.players[tIdx]; const text = cTxt.toLowerCase(); playSfx(sfx.stop);
                let bMsg = `⚡ Объект ${pName} применяет козырь:\n"${cTxt}"\n\n`;

                if (text.includes('убей') || text.includes('смерть') || text.includes('эвтаназия') || text.includes('кара')) { update(`players/${tIdx}/isExiled`, true); bMsg += `💀 Объект №${target.id} (${target.name}) ИЗГНАН/УБИТ!`; }
                else if (text.includes('вылечи') || text.includes('здоровье ->')) { update(`players/${tIdx}/health`, "Идеальное здоровье"); bMsg += `💉 Объект №${target.id} полностью излечен!`; }
                else if (text.includes('радиация') || text.includes('лучевая')) { update(`players/${tIdx}/health`, "Лучевая болезнь (Критическая)"); bMsg += `☢️ Объект №${target.id} получил критическую дозу радиации!`; }
                else if (text.includes('огнестрел') || text.includes('травм')) { update(`players/${tIdx}/health`, "Тяжелая травма (Кровотечение)"); bMsg += `🩸 Объекту №${target.id} нанесена травма!`; }
                else if (text.includes('инвалид') || text.includes('хромы')) { update(`players/${tIdx}/health`, "Инвалидность (Без ноги)"); bMsg += `🦽 Объект №${target.id} покалечен!`; }
                else if (text.includes('инфекция') || text.includes('зарази')) { update(`players/${tIdx}/health`, gameState.players[pIdx].health); bMsg += `🦠 Болезнь передана объекту №${target.id}!`; }
                else if (text.includes('плодовит') || text.includes('дева мария')) { update(`players/${tIdx}/fert`, "ПЛОДОВИТ (ИДЕАЛЬНО)"); bMsg += `🧬 ДНК объекта №${target.id} улучшено!`; }
                else if (text.includes('бесплод') || text.includes('генетический сбой')) { update(`players/${tIdx}/fert`, "БЕСПЛОДЕН"); bMsg += `🥀 Объект №${target.id} теперь бесплоден.`; }
                else if (text.includes('забери') || text.includes('укради') || text.includes('ограбление') || text.includes('мародер')) {
                    const stolenBag = target.bag; update(`players/${tIdx}/bag`, "Пустой рюкзак (Ограблен)");
                    if (pIdx !== tIdx) update(`players/${pIdx}/bag`, stolenBag); bMsg += `🎒 Рюкзак объекта №${target.id} облутан!`;
                }
                else if (text.includes('обмен') || text.includes('скам') || text.includes('бартер')) {
                    const myBag = gameState.players[pIdx].bag; update(`players/${pIdx}/bag`, target.bag); update(`players/${tIdx}/bag`, myBag); bMsg += `🔄 Игроки махнулись рюкзаками!`;
                }
                else if (text.includes('трупный яд') || text.includes('испорти')) { update(`players/${tIdx}/bag`, "Сгнивший мусор (Испорчено)"); bMsg += `🤢 Инвентарь объекта №${target.id} испорчен!`; }
                else if (text.includes('обнуление')) { gameState.players.forEach((p, i) => update(`players/${i}/bag`, "Пустой рюкзак")); bMsg += `💥 ГЛОБАЛЬНЫЙ ВАЙП ИНВЕНТАРЯ У ВСЕХ!`; }
                else if (text.includes('ампутация')) { update(`players/${tIdx}/health`, "Идеальное здоровье"); update(`players/${tIdx}/bag`, "Пустой рюкзак"); bMsg += `✂️ Объект №${target.id} вылечен ценой потери инвентарь!`; }
                else if (text.includes('лоботомия') || text.includes('профнепригодность')) { update(`players/${tIdx}/prof`, "Безработный Овощ"); bMsg += `🧠 Объект №${target.id} потерял профессию!`; }
                else if (text.includes('скопируй') || text.includes('плагиат')) { update(`players/${pIdx}/prof`, target.prof); bMsg += `🎭 Профессия скопирована!`; }
                else if (text.includes('психушка')) { update(`players/${tIdx}/phob`, target.hobby); update(`players/${tIdx}/hobby`, "Отсутствует"); bMsg += `🤡 Хобби объекта №${target.id} стало его фобией!`; }
                else if (text.includes('реинкарнация')) { update(`players/${tIdx}/prof`, roll('prof')); update(`players/${tIdx}/health`, roll('health')); update(`players/${tIdx}/hobby`, roll('hobby')); bMsg += `✨ Полная реинкарнация статов объекта №${target.id}!`; }
                else if (text.includes('вскрой') || text.includes('доносчик') || text.includes('разоблачение') || text.includes('грязное белье') || text.includes('сыщик')) { update(`players/${tIdx}/revealed/f1`, true); update(`players/${tIdx}/revealed/f2`, true); update(`players/${tIdx}/revealed/hobby`, true); bMsg += `📢 Принудительное вскрытие фактов и хобби объекта №${target.id}!`; }
                else if (text.includes('апокалипсис')) { gameState.players.forEach((p, i) => update(`players/${i}/revealed`, {bio:true, prof:true, health:true, bag:true, hobby:true, phob:true, fert:true, f1:true, f2:true})); bMsg += `🚨 АПОКАЛИПСИС! ВСЕ КАРТЫ У ВСЕХ ВСКРЫТЫ! 🚨`; }
                else { bMsg += `👉 На объекте №${target.id} применен эффект козыря. Соблюдайте правила карты!`; } 

                botSay(bMsg);
                update(`players/${pIdx}/actions`, gameState.players[pIdx].actions.filter(a => a !== cTxt));
            };

            const triggerCard = (pIdx, cTxt, pName) => {
                if (cTxt.toLowerCase().match(/сосед|игрок|кого|кому|забери|укради|убей|вскрой|цель|двоих|обмен|мародер|отдай|нанеси|свяжи|заставь|ослепление/)) {
                    setActiveActionModal({pIdx, cTxt, pName}); // Открывает красивое меню выбора жертвы
                } else {
                    executeCard(pIdx, cTxt, pName, pIdx); // Применяет на себя или глобально
                }
            };

            const init = () => {
                const players = Array.from({ length: parseInt(pCount) }, (_, i) => {
                    const sex = roll('sex');
                    const bName = sex === "МУЖ" ? BOT_NAMES_M[Math.floor(Math.random()*BOT_NAMES_M.length)] : BOT_NAMES_F[Math.floor(Math.random()*BOT_NAMES_F.length)];
                    const bSurname = SURNAMES[Math.floor(Math.random()*SURNAMES.length)] + (sex === "ЖЕН" ? "а" : "");
                    const fullName = `${bName} ${bSurname}`;
                    return { 
                        id: i + 1, uid: '', name: fullName, sex, age: roll('age'), prof: roll('prof'), profExp: roll('years'), health: roll('health'), bag: roll('bag'), hobby: roll('hobby'), hobbyExp: roll('years'), phob: roll('phob'), f1: roll('facts'), f2: roll('facts'), fert: roll('fert'), 
                        actions: [MY_ACTION_CARDS[Math.floor(Math.random()*MY_ACTION_CARDS.length)], MY_ACTION_CARDS[Math.floor(Math.random()*MY_ACTION_CARDS.length)]], 
                        revealed: {}, votedBy: "", isExiled: false, 
                        avatar: `https://api.dicebear.com/7.x/bottts/svg?seed=${fullName}` 
                    };
                });
                
                const half = Math.floor(parseInt(pCount) / 2);
                const targetA = Math.max(1, Math.floor(Math.random() * (half > 1 ? half - 1 : 1)) + 1);
                
                db.ref('game').set({ players, time: 0, active: false, phase: 'waiting', round: 1, targetAlive: targetA, speakerId: null, globalStop: null, locked: false, dice: 1, turnTime: 0, discussionTime: 0, votingTime: 0, eventTime: 0, eventDone: false, aiHost: true, createdBy: userName, creatorRole: role, bunker: { d: 'КАТАСТРОФА...', b: 'БУНКЕР...', i: 'ИНВЕНТАРЬ...' } });
                
                setTimeout(() => db.ref('chat').push({ uid: 'ai_bot', name: 'ИИ-ВЕДУЩАЯ 🤖', role: 'host', text: `✅ Бункер сгенерирован!\nЖдем заполнения лобби или команды "!старт".`, time: Date.now() }), 1000);
            };

            if (isBanned) return ( 
                <div className="glass-overlay">
                    <div className="glass-box border-red-500 w-full max-w-lg shadow-[0_0_100px_rgba(239,68,68,0.3)] bg-black/80">
                        <h1 className="text-4xl font-black text-red-500 uppercase drop-shadow-[0_0_10px_red]">ДОСТУП ЗАПРЕЩЕН</h1>
                        <p className="mt-4 text-white/70 font-medium text-lg mb-6">Ваш аккаунт заблокирован администрацией за нарушения.</p>
                        <textarea value={appealText} onChange={e => setAppealText(e.target.value)} className="p-input text-base h-32 mb-4 !border-red-500/30 focus:!border-red-500 bg-black" placeholder="Напишите Владельцу причину, если считаете бан ошибкой..."></textarea>
                        <button onClick={() => {
                            if(!appealText) return setSysAlert({t:'ОШИБКА', d:'Напишите текст апелляции!'});
                            db.ref('appeals').push({ uid: user.uid, name: userName, text: appealText, time: Date.now() });
                            setAppealText("");
                            setSysAlert({t:'ОТПРАВЛЕНО', d:'Ваша жалоба ушла Владельцу. Ждите решения.'});
                        }} className="bg-red-600 text-white w-full py-4 rounded-xl font-black uppercase tracking-widest hover:bg-red-500 transition-colors shadow-[0_0_20px_rgba(239,68,68,0.4)]">Подать Апелляцию</button>
                        <button onClick={() => auth.signOut()} className="mt-6 text-white/30 text-xs font-black uppercase hover:text-white transition-colors">Выйти из аккаунта</button>
                    </div>
                    {/* Кастомный алерт для окна бана */}
                    {sysAlert && (
                        <div className="fixed inset-0 z-[99999] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fadeIn" onClick={() => setSysAlert(null)}>
                            <div className="bg-black border-2 border-white/20 p-8 rounded-3xl max-w-sm w-full text-center shadow-[0_0_50px_rgba(255,255,255,0.1)]" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-black uppercase tracking-widest text-white mb-4">{sysAlert.t}</h3>
                                <p className="text-white/80 font-medium mb-8">{sysAlert.d}</p>
                                <button onClick={() => setSysAlert(null)} className="w-full bg-white text-black py-3 rounded-xl font-black uppercase hover:bg-gray-200">Понятно</button>
                            </div>
                        </div>
                    )}
                </div> 
            );

            if (!user) return (
                <div className="glass-overlay"><div className="glass-box border-white/20">
                    <h1 className="text-4xl font-black mb-8 tracking-widest uppercase">{authMode === 'login' ? 'ВХОД' : 'РЕГИСТРАЦИЯ'}</h1>
                    {authMode === 'register' && (
                        <div className="flex flex-col items-center mb-6">
                            <input type="file" id="ava-upload" accept="image/*" className="hidden" onChange={handleAvatarUpload} />
                            <label htmlFor="ava-upload" className="cursor-pointer flex flex-col items-center">
                                <img src={regAvatar} className="w-24 h-24 rounded-2xl border-2 border-white/20 object-cover hover:scale-105 transition shadow-lg" />
                                <span className="text-[10px] opacity-50 mt-2 uppercase font-bold">Аватар</span>
                            </label>
                            <input type="text" value={regName} onChange={e => setRegName(e.target.value)} className="p-input text-xl py-3 mt-4" placeholder="Ваш Позывной" />
                        </div>
                    )}
                    <input type="text" value={email} onChange={e => setEmail(e.target.value)} className="p-input text-xl py-3" placeholder="Логин (Ник) или E-mail" />
                    <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="p-input text-xl py-3 mb-8" placeholder="Пароль" />
                    <button onClick={handleAuth} className="bg-white text-black px-16 py-4 rounded-2xl font-black uppercase text-xl w-full hover:bg-gray-200 mb-4">{authMode === 'login' ? 'ВОЙТИ' : 'СОЗДАТЬ'}</button>
                    <p className="text-sm opacity-50 cursor-pointer hover:opacity-100 uppercase font-bold" onClick={() => setAuthMode(authMode === 'login' ? 'register' : 'login')}>{authMode === 'login' ? 'Регистрация' : 'Войти'}</p>
                    {sysAlert && (
                        <div className="fixed inset-0 z-[99999] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fadeIn" onClick={() => setSysAlert(null)}>
                            <div className="bg-black border-2 border-white/20 p-8 rounded-3xl max-w-sm w-full text-center shadow-[0_0_50px_rgba(255,255,255,0.1)]" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-black uppercase tracking-widest text-white mb-4">{sysAlert.t}</h3>
                                <p className="text-white/80 font-medium mb-8">{sysAlert.d}</p>
                                <button onClick={() => setSysAlert(null)} className="w-full bg-white text-black py-3 rounded-xl font-black uppercase hover:bg-gray-200">Понятно</button>
                            </div>
                        </div>
                    )}
                </div></div>
            );

            if (!user || !gameState) return (
                <div className="glass-overlay"><div className="glass-box">
                    <h1 className="text-4xl font-black mb-10 tracking-widest uppercase">ИГРА НЕ НАЙДЕНА</h1>
                    <p className="text-sm opacity-50 mb-2 uppercase font-bold text-left px-2">Количество Игроков</p>
                    <input type="number" value={pCount} onChange={e => setPCount(e.target.value)} className="p-input mb-8" />
                    <button onClick={init} className="bg-white text-black px-16 py-6 rounded-3xl font-black uppercase text-2xl w-full hover:scale-105">Создать Лобби</button>
                </div></div>
            );
            
            const myIdx = gameState.players.findIndex(p => p.uid === user.uid);
            const isMeSpk = myIdx !== -1 && gameState.speakerId === gameState.players[myIdx].id;
            const maxVotes = Math.max(...gameState.players.map(p => getVotes(p).length));
            
            // === СИСТЕМА ПРАВ ===
            const staffRoles = ['owner', 'admin', 'host', 'curator', 'tester'];
            const isStaff = staffRoles.includes(role);
            const isReallyAdmin = isAdmin && isStaff && myIdx === -1; 

            const isGod = isReallyAdmin && (role === 'owner' || role === 'tester'); 
            const canEdit = isReallyAdmin && (role === 'owner' || role === 'admin' || role === 'tester'); 
            const canPlay = isReallyAdmin && (role === 'owner' || role === 'admin' || role === 'host' || role === 'tester'); 
            
            const canExile = isReallyAdmin && (role === 'owner' || role === 'admin' || role === 'host' || role === 'tester');
            const canWarn = isReallyAdmin && (role === 'owner' || role === 'admin' || role === 'curator' || role === 'tester');

            // === ЭКРАН ПРОФИЛЯ ===
            if (viewProfile || currentView === 'profile') {
                const targetUser = viewProfile || user; 
                const isMyProfile = targetUser.uid === user?.uid;
                
                const pName = isMyProfile ? userName : targetUser.name;
                const pAva = isMyProfile ? userAvatar : targetUser.avatar;
                const pRole = isMyProfile ? role : (targetUser.role || 'player');
                const pStats = isMyProfile ? userStats : (targetUser.stats || {games:0, survived:0});
                const pId = isMyProfile ? userId : (targetUser.userId || 0);
                const pWarns = targetUser.warns || 0;

                const changeProfileAvatar = (e) => {
                    const file = e.target.files[0];
                    if (file && isMyProfile) {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const newAva = reader.result;
                            setUserAvatar(newAva);
                            db.ref(`users/${user.uid}/avatar`).set(newAva);
                            if (myIdx !== -1) update(`players/${myIdx}/avatar`, newAva);
                        };
                        reader.readAsDataURL(file);
                    }
                };

                return (
                    <div className="fixed inset-0 z-[9999] flex justify-center items-center bg-black/80 backdrop-blur-[25px] animate-fadeIn">
                        <div className="glass-box border-white/20 w-full max-w-4xl p-12 flex flex-col items-center relative shadow-[0_0_100px_rgba(0,0,0,1)] bg-black/50">
                            <button onClick={() => { setViewProfile(null); setCurrentView('game'); }} className="absolute top-8 right-8 text-white/50 hover:text-white font-black text-2xl transition-colors">✕</button>
                            
                            <div className="relative group mb-6">
                                <div className="w-40 h-40 rounded-full border-4 border-white/20 overflow-hidden shadow-[0_0_50px_rgba(255,255,255,0.1)] bg-black">
                                    <img src={pAva || `https://i.pravatar.cc/300?u=${targetUser.uid}`} className="w-full h-full object-cover" alt="avatar" />
                                </div>
                                {isMyProfile && (
                                    <label className="absolute inset-0 bg-black/60 rounded-full flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
                                        <span className="text-3xl mb-1">📸</span>
                                        <span className="text-[10px] font-black uppercase">Сменить</span>
                                        <input type="file" accept="image/*" className="hidden" onChange={changeProfileAvatar} />
                                    </label>
                                )}
                            </div>
                            
                            <h1 className="text-5xl font-black uppercase tracking-widest mb-4 text-white drop-shadow-md">{pName || "ОБЪЕКТ"}</h1>
                            
                            <div className="flex gap-4 mb-10">
                                <div className={`px-6 py-2.5 rounded-xl border-2 font-mono tracking-[0.1em] shadow-lg text-sm font-black uppercase
                                    ${pRole === 'owner' ? 'bg-red-900/40 border-red-500 text-red-400 drop-shadow-[0_0_10px_red]' : 
                                      pRole === 'admin' ? 'bg-yellow-900/40 border-yellow-500 text-yellow-400 drop-shadow-[0_0_10px_yellow]' : 
                                      pRole === 'curator' ? 'bg-purple-900/40 border-purple-500 text-purple-400 drop-shadow-[0_0_10px_purple]' : 
                                      pRole === 'host' ? 'bg-blue-900/40 border-blue-500 text-blue-400 drop-shadow-[0_0_10px_blue]' : 
                                      pRole === 'tester' ? 'bg-orange-900/40 border-orange-500 text-orange-400 drop-shadow-[0_0_10px_orange]' : 
                                      'bg-white/10 border-white/30 text-white/80'}`}>
                                    ID: {pId || "?"} | РОЛЬ: {pRole}
                                </div>
                                <div className={`px-6 py-2.5 rounded-xl border-2 font-mono text-sm font-black uppercase flex items-center gap-2
                                    ${pWarns >= 2 ? 'bg-red-900/40 border-red-500 text-red-400 animate-pulse' : pWarns === 1 ? 'bg-orange-900/40 border-orange-500 text-orange-400' : 'bg-green-900/40 border-green-500 text-green-400'}`}>
                                    ВАРНЫ: {pWarns} / 3
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-8 w-full mb-10">
                                <div className="bg-white/5 border border-white/10 rounded-3xl p-8 flex flex-col items-center justify-center shadow-lg">
                                    <span className="text-6xl font-black mb-2">{pStats.games || 0}</span>
                                    <span className="text-xs uppercase tracking-widest opacity-50 font-bold">Сыграно игр</span>
                                </div>
                                <div className="bg-green-500/10 border border-green-500/30 rounded-3xl p-8 flex flex-col items-center justify-center shadow-[0_0_30px_rgba(34,197,94,0.1)]">
                                    <span className="text-6xl font-black text-green-400 mb-2">{pStats.survived || 0}</span>
                                    <span className="text-xs uppercase tracking-widest text-green-400/50 font-bold">Побед</span>
                                </div>
                            </div>

                            <div className="w-full bg-white/5 border border-white/10 rounded-3xl p-8">
                                <h3 className="text-xl font-black uppercase tracking-widest mb-6 border-b border-white/10 pb-4 text-left">Зал Славы</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    {[
                                        { req: pStats.games >= 1, icon: '🩸', name: 'Первая кровь', desc: 'Сыграть 1 игру' },
                                        { req: pStats.survived >= 1, icon: '🍀', name: 'Счастливчик', desc: 'Выжить 1 раз' },
                                        { req: pStats.games >= 5, icon: '🏕️', name: 'Сталкер', desc: 'Сыграть 5 игр' },
                                        { req: pStats.survived >= 5, icon: '👑', name: 'Ветеран', desc: 'Выжить 5 раз' },
                                        { req: pStats.games >= 10, icon: '☢️', name: 'Мутант', desc: 'Сыграть 10 игр' },
                                        { req: pStats.survived >= 10, icon: '🏆', name: 'Легенда Бункера', desc: 'Выжить 10 раз' },
                                        { req: pStats.games >= 25, icon: '💀', name: 'Дитя Пустоши', desc: 'Сыграть 25 игр' },
                                        { req: pStats.survived >= 25, icon: '🧬', name: 'Сверхчеловек', desc: 'Выжить 25 раз' },
                                    ].map((ach, i) => (
                                        <div key={i} className={`flex flex-col items-center p-3 rounded-2xl border transition-all duration-300 ${ach.req ? 'bg-white/10 border-white/30 shadow-[0_0_20px_rgba(255,255,255,0.1)] hover:scale-105 hover:bg-white/20' : 'bg-black/50 border-white/5 opacity-40 grayscale'}`}>
                                            <div className="text-4xl mb-3 drop-shadow-lg">{ach.req ? ach.icon : '🔒'}</div>
                                            <div className="text-[10px] font-black uppercase tracking-widest text-center mb-1 text-white/90">{ach.req ? ach.name : 'Секрет'}</div>
                                            <div className="text-[8px] font-bold uppercase text-white/40 text-center">{ach.desc}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {isMyProfile && (
                                <button onClick={() => { auth.signOut(); window.location.reload(); }} className="mt-10 text-red-500 hover:text-red-400 text-[10px] font-black uppercase tracking-widest border-b border-red-500/30 pb-1 transition-colors">
                                    ПОКИНУТЬ БУНКЕР (ВЫХОД)
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            return (
                <div className={`overlay ${gameState.speakerId ? 'focus-mode' : ''}`} tabIndex="0">
                    
                    {/* РЕДИЗАЙН: ОКНО ВЫБОРА ЦЕЛИ ДЛЯ КАРТЫ */}
                    {activeActionModal && (
                        <div className="fixed inset-0 z-[99998] flex items-center justify-center bg-black/90 backdrop-blur-md animate-fadeIn">
                            <div className="bg-[#0a0a1a] border-2 border-cyan-500/50 p-10 rounded-[40px] max-w-4xl w-full shadow-[0_0_100px_rgba(6,182,212,0.3)] text-center relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-400 to-transparent opacity-50"></div>
                                <h2 className="text-4xl font-black uppercase text-white mb-2 tracking-widest drop-shadow-[0_0_10px_cyan]">Выберите цель</h2>
                                <p className="text-cyan-300 font-bold mb-8 bg-cyan-900/30 py-3 rounded-xl border border-cyan-500/20 shadow-inner">"{activeActionModal.cTxt}"</p>
                                <div className="grid grid-cols-4 gap-4 mb-8">
                                    {gameState.players.filter(p => !p.isExiled).map((p) => (
                                        <div key={p.id} onClick={() => { executeCard(activeActionModal.pIdx, activeActionModal.cTxt, activeActionModal.pName, gameState.players.findIndex(x => x.id === p.id)); setActiveActionModal(null); }} 
                                            className="bg-white/5 border border-white/10 rounded-2xl p-4 cursor-pointer hover:scale-105 hover:bg-cyan-900/40 hover:border-cyan-400 transition-all group shadow-lg">
                                            <div className="relative">
                                                <img src={p.avatar} className="w-16 h-16 rounded-full mx-auto mb-3 object-cover border-2 border-transparent group-hover:border-cyan-400 transition-colors" />
                                                {!p.uid && <div className="absolute top-0 right-2 bg-blue-600 w-4 h-4 rounded-full border border-white shadow-[0_0_10px_blue]" title="Бот"></div>}
                                            </div>
                                            <div className="text-[11px] font-black uppercase truncate text-white/90 group-hover:text-white">{p.name}</div>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => setActiveActionModal(null)} className="bg-white/10 text-white px-12 py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-white/20 transition-colors">Отмена</button>
                            </div>
                        </div>
                    )}

                    {/* РЕДИЗАЙН: ТАБЛИЦА ГОЛОСОВАНИЯ */}
                    {votingModal && (
                        <div className="fixed inset-0 z-[99998] flex items-center justify-center bg-black/90 backdrop-blur-md animate-fadeIn">
                            <div className="bg-[#1a0505] border-2 border-red-600/50 p-10 rounded-[40px] max-w-4xl w-full shadow-[0_0_150px_rgba(220,38,38,0.4)] text-center relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-500 to-transparent opacity-50"></div>
                                <h2 className="text-5xl font-black uppercase text-red-500 mb-8 tracking-widest drop-shadow-[0_0_15px_red]">КОГО ИЗГОНЯЕМ?</h2>
                                <div className="grid grid-cols-4 gap-5 mb-10">
                                    {gameState.players.filter(p => !p.isExiled).map(p => {
                                        const votesArr = getVotes(p);
                                        const iVoted = votesArr.includes(user.uid);
                                        return (
                                        <div key={p.id} onClick={() => { 
                                            // Сначала стираем голос с остальных
                                            gameState.players.forEach((op, idx) => {
                                                if (op.id !== p.id) {
                                                    const opVotes = getVotes(op);
                                                    if (opVotes.includes(user.uid)) {
                                                        update(`players/${idx}/votedBy`, opVotes.filter(x => x !== user.uid));
                                                    }
                                                }
                                            });
                                            // Затем ставим или убираем текущему
                                            update(`players/${p.id - 1}/votedBy`, iVoted ? votesArr.filter(x => x !== user.uid) : [...votesArr, user.uid]); 
                                            }} 
                                            className={`border rounded-2xl p-5 cursor-pointer transition-all ${iVoted ? 'bg-red-900/60 border-red-500 shadow-[0_0_30px_red] transform scale-105' : 'bg-white/5 border-white/10 hover:bg-red-900/20 hover:border-red-500/30'}`}>
                                            <div className="relative">
                                                <img src={p.avatar} className={`w-20 h-20 rounded-full mx-auto mb-3 object-cover border-2 ${iVoted ? 'border-red-400' : 'border-transparent'}`} />
                                                {!p.uid && <div className="absolute top-0 right-4 bg-blue-600 w-4 h-4 rounded-full border border-white shadow-[0_0_10px_blue]" title="Бот"></div>}
                                            </div>
                                            <div className="text-[12px] font-black uppercase truncate text-white/90">{p.name}</div>
                                            <div className={`text-[14px] mt-2 font-black ${votesArr.length > 0 ? 'text-red-400 drop-shadow-[0_0_5px_red]' : 'text-white/30'}`}>Голосов: {votesArr.length}</div>
                                        </div>
                                    )})}
                                </div>
                                <button onClick={() => setVotingModal(false)} className="bg-white/5 border border-white/20 text-white/80 px-12 py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-white/10 hover:text-white transition-colors">Свернуть таблицу</button>
                            </div>
                        </div>
                    )}

                    {/* КАСТОМНЫЕ ОКНА УВЕДОМЛЕНИЙ */}
                    {sysAlert && (
                        <div className="fixed inset-0 z-[99999] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fadeIn" onClick={() => setSysAlert(null)}>
                            <div className="bg-black/90 border-2 border-white/20 p-8 rounded-3xl max-w-sm w-full text-center shadow-[0_0_50px_rgba(255,255,255,0.1)]" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-black uppercase tracking-widest text-white mb-4">{sysAlert.t}</h3>
                                <p className="text-white/80 font-medium mb-8">{sysAlert.d}</p>
                                <button onClick={() => setSysAlert(null)} className="w-full bg-white text-black py-3 rounded-xl font-black uppercase hover:bg-gray-200">Понятно</button>
                            </div>
                        </div>
                    )}

                    {/* ОКНО НАКАЗАНИЯ (ПРИЧИНА) */}
                    {punishModal && (
                        <div className="fixed inset-0 z-[99998] flex items-center justify-center bg-black/80 backdrop-blur-md animate-fadeIn">
                            <div className="bg-black border-2 border-red-500/50 p-8 rounded-3xl max-w-lg w-full shadow-[0_0_50px_rgba(239,68,68,0.2)]">
                                <h3 className="text-2xl font-black uppercase text-red-400 mb-2">Наказание: {punishModal.name}</h3>
                                <p className="text-white/50 text-sm mb-6 uppercase font-bold">Опишите причину. Она запишется в логи.</p>
                                <input autoFocus value={punishReason} onChange={e => setPunishReason(e.target.value)} placeholder="Причина (мат, оск, лив и тд)..." className="p-input text-lg py-4 mb-6 !border-red-500/30 focus:!border-red-500" />
                                <div className="flex gap-4">
                                    <button onClick={executePunishment} className="flex-grow bg-red-600 text-white py-3 rounded-xl font-black uppercase hover:scale-105 transition-transform shadow-[0_0_20px_rgba(239,68,68,0.4)]">Выдать</button>
                                    <button onClick={() => {setPunishModal(null); setPunishReason("");}} className="px-8 bg-white/10 text-white py-3 rounded-xl font-black uppercase hover:bg-white/20 transition-colors">Отмена</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ПАНЕЛЬ ШТАБА (СПИСОК АДМИНОВ) */}
                    {showStaffPanel && (
                        <div className="fixed inset-0 z-[99997] flex items-center justify-center bg-black/80 backdrop-blur-[20px] animate-fadeIn">
                            <div className="bg-black/90 border-2 border-red-500/30 p-10 rounded-[40px] max-w-3xl w-full max-h-[80vh] flex flex-col shadow-[0_0_100px_rgba(239,68,68,0.2)]">
                                <div className="flex justify-between items-center mb-8 border-b border-red-500/20 pb-6">
                                    <h2 className="text-4xl font-black uppercase text-red-400 tracking-widest drop-shadow-[0_0_10px_red]">Штаб Кураторов</h2>
                                    <button onClick={() => setShowStaffPanel(false)} className="text-white/50 hover:text-white font-black text-2xl">✕</button>
                                </div>
                                
                                <div className="flex-grow overflow-y-auto pr-4 space-y-4">
                                    {staffList.length === 0 ? <p className="text-center text-white/40 uppercase font-black py-10">В штабе пока пусто...</p> : 
                                        staffList.map(st => (
                                            <div key={st.uid} className="bg-white/5 border border-white/10 p-5 rounded-2xl flex items-center justify-between hover:bg-white/10 transition-colors">
                                                <div className="flex items-center gap-4">
                                                    <img src={st.avatar || `https://i.pravatar.cc/150?u=${st.uid}`} className="w-14 h-14 rounded-xl object-cover border border-white/20" />
                                                    <div>
                                                        <div className="font-black text-xl uppercase tracking-wider">{st.name || "Аноним"}</div>
                                                        <div className="text-[10px] font-mono text-red-400 font-bold uppercase tracking-widest mt-1">РОЛЬ: {st.role} | ID: {st.userId} | ВАРНЫ: {st.adminWarns||0}/3</div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => { setShowStaffPanel(false); setPunishModal({uid: st.uid, name: st.name, type: 'adminWarn'}); }} className="bg-red-500/20 text-red-400 border border-red-500/50 px-4 py-2 rounded-xl font-black text-[10px] uppercase hover:bg-red-500 hover:text-white transition-all">ВЫГОВОР</button>
                                                </div>
                                            </div>
                                        ))
                                    }
                                </div>
                            </div>
                        </div>
                    )}

                    {showEndModal && (
                        <div className="glass-overlay z-[9999]"><div className="glass-box border-green-500/50 max-w-2xl w-full">
                            <h2 className="text-5xl font-black mb-6 uppercase text-green-400 drop-shadow-[0_0_15px_rgba(34,197,94,0.5)]">Итоги Бункера</h2>
                            <p className="mb-8 opacity-80 text-lg">Статистика будет начислена всем игрокам.</p>
                            <div className="flex flex-wrap gap-3 justify-center mb-10">
                                {gameState.players.filter(p => p.uid && !p.isExiled).map(p => (
                                    <div key={p.id} className="bg-green-500/20 border border-green-500/50 px-4 py-2 rounded-xl text-green-300 font-black text-sm shadow-[0_0_10px_rgba(34,197,94,0.2)]">
                                        {p.name} 🏆
                                    </div>
                                ))}
                            </div>
                            <div className="flex gap-4 justify-center">
                                <button onClick={handleEndGame} className="bg-green-600 text-white px-10 py-4 rounded-xl font-black text-lg hover:scale-105 transition-transform shadow-[0_0_20px_rgba(34,197,94,0.4)]">ЗАКРЫТЬ ЛОББИ</button>
                                <button onClick={() => setShowEndModal(false)} className="bg-white/10 px-10 py-4 rounded-xl font-black text-lg hover:bg-white/20 transition-colors">ОТМЕНА</button>
                            </div>
                        </div></div>
                    )}
                        
                    {showOwnerPanel && (
                        <div className="glass-overlay z-[9999]"><div className="glass-box border-purple-500/50">
                            <h2 className="text-4xl font-black mb-8 uppercase text-purple-400 drop-shadow-[0_0_15px_rgba(168,85,247,0.5)]">Выдача Ролей</h2>
                            <p className="text-sm opacity-50 mb-2 uppercase font-bold text-left px-2">ID Игрока</p>
                            <input type="number" value={targetUserId} onChange={e => setTargetUserId(e.target.value)} className="p-input mb-4" placeholder="Например: 192" />
                            <p className="text-sm opacity-50 mb-2 uppercase font-bold text-left px-2">Выберите роль</p>
                            <select value={targetRole} onChange={e => setTargetRole(e.target.value)} className="w-full bg-white/5 border-2 border-white/20 rounded-xl p-4 text-xl text-white font-black mb-8 outline-none [&>option]:bg-black [&>option]:text-white">
                                <option value="player">Игрок</option>
                                <option value="admin">Администратор</option>
                                <option value="host">Ведущий</option>
                                <option value="curator">Куратор</option>
                                <option value="tester">Тестер</option>
                            </select>
                            <div className="flex gap-4 justify-center">
                                <button onClick={assignRole} className="bg-purple-600 text-white px-10 py-3 rounded-xl font-black text-lg hover:scale-105 transition-transform shadow-[0_0_20px_rgba(168,85,247,0.4)]">ВЫДАТЬ</button>
                                <button onClick={() => setShowOwnerPanel(false)} className="bg-white/10 px-10 py-3 rounded-xl font-black text-lg hover:bg-white/20 transition-colors">ОТМЕНА</button>
                            </div>
                        </div></div>
                    )}

                    {/* БАННЕР СОБЫТИЯ (Теперь не блокирует экран и пропадает сам) */}
                    {gameState.currentEvent && (
                        <div className="event-overlay z-[8000]">
                            <div className="event-box">
                                <img src={gameState.currentEvent.img} className="mx-auto h-64 w-full object-cover rounded-3xl mb-6 border-2 border-blue-500/50 shadow-2xl" />
                                <h1 className="text-5xl font-black uppercase mb-4 text-blue-400 drop-shadow-[0_0_10px_blue]">{gameState.currentEvent.t}</h1>
                                <p className="text-2xl font-bold uppercase max-w-3xl mx-auto text-white/90">"{gameState.currentEvent.d}"</p>
                                <div className="mt-6 inline-block bg-blue-600 text-white px-6 py-2 rounded-full font-black uppercase animate-pulse">Пишите решение в чат!</div>
                            </div>
                        </div>
                    )}
                    
                    {gameState.globalStop && <div className="glass-overlay z-[9990]" onClick={() => { playSfx(sfx.stop); isAdmin && update('globalStop', null); }}><div className="glass-box border-white"><h1 className="text-8xl font-black uppercase mb-2">СТОП ИГРА!</h1><h2 className="text-3xl uppercase opacity-60 mb-6">{gameState.globalStop.user} АКТИВИРУЕТ КОЗЫРЬ</h2><p className="text-4xl font-black italic">"{gameState.globalStop.text}"</p></div></div>}
                    
                    {isMeSpk && !gameState.players[myIdx].isExiled && gameState.phase === 'speaking' && gameState.turnTime === -1 && (
                        <div className="glass-overlay z-[8000]"><div className="glass-box border-white"><h2 className="text-4xl font-black text-white mb-12 uppercase tracking-widest">ПРОТОКОЛ ВСКРЫТИЯ</h2>
                            <div className="grid grid-cols-2 gap-6">{['bio','prof','health','bag','hobby','phob','fert','f1','f2'].map(f => {
                            const p = gameState.players[myIdx];
                            const isRev = f === 'bio' ? (p.revealed?.sex || p.revealed?.age) : p.revealed?.[f];
                            const val = f === 'bio' ? `${p.sex}, ${p.age}л` : p[f];
                        return (
                        <button key={f} disabled={isRev} onClick={() => { if(!isRev) { playSfx(sfx.open); db.ref(`game/players/${myIdx}/revealed/${f === 'bio' ? 'sex' : f}`).set(true); if(f === 'bio') db.ref(`game/players/${myIdx}/revealed/age`).set(true); db.ref('game/turnTime').set(60);} }} className={`flex items-center justify-between px-6 py-4 rounded-2xl font-black uppercase text-xs transition-all border-2 ${isRev ? 'bg-green-500/20 border-green-500/50 text-green-400' : 'bg-white/5 border-white/20 hover:bg-white hover:text-black'}`}>
                            <span>{LABELS[f]} {isRev ? '' : `(${val})`}</span>{isRev && <span className="text-lg">✓</span>}
                        </button>);
                    })}</div></div></div>
                    )}
                    
                    {/* КНОПКА ГОЛОСОВАНИЯ */}
                    {gameState.phase === 'voting' && myIdx !== -1 && !gameState.players[myIdx].isExiled && (
                        <div className="fixed top-8 left-1/2 -translate-x-1/2 z-[9000]">
                            <button onClick={() => setVotingModal(true)} className="bg-red-600 text-white px-16 py-4 rounded-[30px] font-black text-2xl uppercase animate-pulse shadow-[0_0_50px_rgba(220,38,38,0.8)] border-4 border-red-400 hover:scale-110 transition-transform">
                                ⚠️ ГОЛОСОВАТЬ ({gameState.votingTime} сек) ⚠️
                            </button>
                        </div>
                    )}

                    <div className="max-w-[1700px] mx-auto flex justify-between items-center mb-12 relative z-[6000]">
                        <div className="flex gap-6">
                            <div className="bg-white/10 border-2 border-white/20 p-3 px-10 rounded-2xl font-mono font-black text-white text-5xl">{Math.floor(gameState.time/60)}:{(gameState.time%60).toString().padStart(2,'0')}</div>
                            
                            {/* ТАЙМЕРЫ */}
                            {gameState.phase === 'speaking' && gameState.turnTime > 0 && gameState.speakerId !== null && (
                                <div className={`border-2 p-3 px-8 rounded-2xl font-mono font-black text-5xl flex items-center justify-center transition-colors ${gameState.turnTime <= 10 ? 'bg-red-600 border-red-400 text-white animate-pulse shadow-[0_0_30px_red]' : 'bg-green-600 border-green-400 text-white shadow-[0_0_30px_rgba(34,197,94,0.5)]'}`}>
                                    🎤 {gameState.turnTime}
                                </div>
                            )}
                            {gameState.phase === 'discussion' && gameState.discussionTime > 0 && (
                                <div className="border-2 p-3 px-8 rounded-2xl font-mono font-black text-5xl flex items-center justify-center transition-colors bg-blue-600 border-blue-400 text-white shadow-[0_0_30px_rgba(59,130,246,0.5)]">
                                    🗣 {Math.floor(gameState.discussionTime/60)}:{(gameState.discussionTime%60).toString().padStart(2,'0')}
                                </div>
                            )}
                            {gameState.phase === 'event' && gameState.eventTime > 0 && (
                                <div className="border-2 p-3 px-8 rounded-2xl font-mono font-black text-5xl flex items-center justify-center transition-colors bg-purple-600 border-purple-400 text-white shadow-[0_0_30px_rgba(168,85,247,0.5)] animate-pulse">
                                    ⚡ {Math.floor(gameState.eventTime/60)}:{(gameState.eventTime%60).toString().padStart(2,'0')}
                                </div>
                            )}

                            <div className="bg-white/10 border-2 border-white/20 p-3 px-8 rounded-2xl flex flex-col items-center justify-center cursor-pointer" onClick={(e) => { if(!isAdmin) return; playSfx(sfx.click); const el = e.currentTarget; el.classList.add('dice-rolling'); setTimeout(() => el.classList.remove('dice-rolling'), 500); update('dice', Math.floor(Math.random()*3)+1); }}>
                                <span className="text-[10px] font-black opacity-30 uppercase text-white">Шанс</span>
                                <div className="text-2xl font-black text-white">{gameState.dice}</div>
                            </div>
                        </div>
                        
                        <div className="text-center">
                            <h1 className="text-6xl font-black text-white tracking-tighter uppercase leading-none">Bunker </h1>
                            <p className="text-[14px] font-black opacity-30 tracking-[10px] mt-2 uppercase text-center">by lvyzap</p>
                        </div>
                        
                        <div className="flex gap-4 items-center relative z-[6000]">
                            {(role === 'owner' || role === 'curator') && (
                                <div onClick={() => setShowStaffPanel(true)} className="px-8 py-3 border-2 border-red-500 text-red-400 rounded-2xl font-black text-[12px] cursor-pointer hover:bg-red-500/20 shadow-[0_0_15px_rgba(239,68,68,0.2)] transition-all">
                                    ШТАБ
                                </div>
                            )}

                            {isGod && (
                                <div onClick={() => setShowOwnerPanel(true)} className="px-8 py-3 border-2 border-purple-500 text-purple-400 rounded-2xl font-black text-[12px] cursor-pointer hover:bg-purple-500/20 shadow-[0_0_15px_rgba(168,85,247,0.2)] transition-all">
                                    РОЛИ
                                </div>
                            )}
                            
                            {isStaff && (
                                <div onClick={() => myIdx === -1 ? setIsAdmin(!isAdmin) : setSysAlert({t:'ВНИМАНИЕ', d:'Освободи слот игрока, чтобы войти в Админ-панель!'})} 
                                     className={`px-8 py-3 border-2 rounded-2xl font-black text-[12px] cursor-pointer transition-all 
                                     ${myIdx !== -1 ? 'border-red-500/50 text-red-500/50 opacity-50 cursor-not-allowed' : isAdmin ? 'bg-white text-black border-white shadow-[0_0_20px_white]' : 'opacity-30 hover:opacity-100'}`}>
                                    {myIdx !== -1 ? 'АДМИНКА БЛОК' : 'АДМИН'}
                                </div>
                            )}
                            
                            <div onClick={() => setViewProfile(user)} className="px-8 py-3 border-2 border-green-500 text-green-400 rounded-2xl font-black text-[12px] cursor-pointer hover:bg-green-500/20 shadow-[0_0_15px_rgba(34,197,94,0.2)] transition-all">
                                ПРОФИЛЬ
                            </div>
                        </div>
                    </div>

                    <div className="bunker-info-grid">{['d','b','i'].map(k => <div key={k} className="info-block"><span>{k==='d'?'Катастрофа':k==='b'?'Бункер':'Инвентарь'}</span><textarea disabled={!isAdmin} value={gameState.bunker?.[k]} onChange={e => update(`bunker/${k}`, e.target.value)} /></div>)}</div>

                    {isAdmin && 
                        <div className="flex gap-6 justify-center mb-12 flex-wrap relative z-[5000] bg-black/40 p-4 rounded-3xl border border-white/10 backdrop-blur-md">
                        {canPlay && (
                            <>
                                <button onClick={() => { playSfx(sfx.raid);update('currentEvent', MY_BUNKER_EVENTS.REID[Math.floor(Math.random()*MY_BUNKER_EVENTS.REID.length)])}} className="bg-red-900 border-2 border-red-500 px-10 py-3 rounded-2xl font-black uppercase text-xs">РЕЙД</button>
                                <button onClick={() => { playSfx(sfx.survivor);update('currentEvent', MY_BUNKER_EVENTS.SURVIVOR[Math.floor(Math.random()*MY_BUNKER_EVENTS.SURVIVOR.length)])}} className="bg-blue-900 border-2 border-blue-500 px-10 py-3 rounded-2xl font-black uppercase text-xs">ВЫЖИВШИЙ</button>
                                <button onClick={() => { 
                                    playSfx(sfx.click);
                                    if (!gameState.active) {
                                        const firstA = gameState.players.find(p => p.uid && !p.isExiled);
                                        if (firstA) { update('active', true); update('speakerId', firstA.id); update('turnTime', -1); }
                                        else { update('active', true); }
                                    } else { update('active', false); }
                                }} className="bg-green-800 border-2 border-green-500 px-10 py-3 rounded-2xl font-black text-xs uppercase">{gameState.active ? 'ПАУЗА' : 'СТАРТ'}</button>
                                <button onClick={() => update('time', 0)} className="bg-white/10 border-2 border-white/20 px-10 py-3 rounded-2xl font-black text-xs uppercase">Сброс Таймера</button>
                                <button onClick={() => setShowEndModal(true)} className="bg-blue-600 border-2 border-blue-400 px-10 py-3 rounded-2xl font-black text-xs uppercase shadow-[0_0_15px_rgba(37,99,235,0.4)]">Завершить игру</button>
                            </>
                        )}
                        {isGod && <button onClick={() => db.ref('game').set(null)} className="bg-red-700 px-10 py-3 rounded-2xl font-black text-xs uppercase shadow-lg shadow-red-900/50 hover:bg-red-500 transition-colors">Сброс Системы</button>}
                    </div>}

                    <div className="game-grid">{gameState.players.map((p, pIdx) => {
                        const isMe = p.uid === user.uid; const isTalking = gameState.speakerId === p.id; const isLdr = maxVotes > 0 && getVotes(p).length === maxVotes;
                        return (
                            <div key={p.id} className={`p-card ${isTalking ? 'speaking-card' : ''} ${isLdr ? 'target-out' : ''} ${p.isExiled ? 'is-exiled-card' : ''} ${!p.uid ? 'border-blue-500/30 bg-blue-900/10' : ''}`}>
                                {p.isExiled && <div className="stamp-exile"><div className="stamp-text">ИЗГНАН</div></div>}
                                {!p.uid && !p.isExiled && <div className="absolute -top-3 -right-3 bg-blue-600 text-white text-[10px] font-black px-4 py-1.5 rounded-full shadow-[0_0_15px_blue] uppercase border border-blue-400 z-40">🤖 Бот</div>}
                                
                                <div className="flex gap-5 mb-8 border-b border-white/10 pb-8">
                                    <div onClick={() => p.uid && setViewProfile(p)} className={`w-32 h-32 border-2 border-white/10 rounded-2xl overflow-hidden bg-black flex-shrink-0 shadow-2xl ${p.uid ? 'cursor-pointer hover:scale-105 hover:border-white/50 transition-all' : ''}`} title={p.uid ? "Посмотреть досье" : ""}>
                                        <img src={p.avatar || `https://i.pravatar.cc/300?u=${p.id}`} className="w-full h-full object-cover pointer-events-none" />
                                    </div>
                                    <div className="flex-grow flex flex-col justify-between py-1">
                                        <div className="font-black text-2xl uppercase tracking-tighter">{p.name || `ОБЪЕКТ ${p.id}`}</div>
                                        <div className={`stat-box ${p.revealed?.fert || isMe || isAdmin ? 'stat-revealed' : ''}`}>
                                            <span className="stat-label">Репродукция {isAdmin && <span onClick={() => update(`players/${pIdx}/fert`, roll('fert'))} className="cursor-pointer">🎲</span>}</span>
                                            {canEdit ? <input className="stat-input" value={p.fert} onChange={e => update(`players/${pIdx}/fert`, e.target.value)} /> : <div className={`font-black text-[13px] uppercase ${(p.revealed?.fert || isMe) && p.fert === 'БЕСПЛОДЕН' ? 'text-red-500 shadow-[0_0_10px_red]' : 'text-white'}`}>{!(isAdmin || isMe || p.revealed?.fert) ? 'Секрет' : p.fert}</div>}
                                        </div>
                                        {!p.uid ? (myIdx===-1 && <button onClick={() => { 
                                            db.ref(`users/${user.uid}`).once('value', snap => {
                                                const d = snap.val() || {};
                                                update(`players/${pIdx}/uid`, user.uid);
                                                update(`players/${pIdx}/name`, d.name || d.Name || userName || `ОБЪЕКТ ${p.id}`);
                                                update(`players/${pIdx}/userId`, d.userId || userId || 0);
                                                update(`players/${pIdx}/stats`, d.stats || userStats || {games:0, survived:0});
                                                const ava = d.avatar || d.Avatar || userAvatar;
                                                if (ava) update(`players/${pIdx}/avatar`, ava);
                                                playSfx(sfx.join);
                                            });
                                        }} className="bg-white text-black text-[10px] font-black py-2.5 rounded-xl mt-3 uppercase hover:scale-105 transition-transform shadow-[0_0_15px_rgba(255,255,255,0.4)] relative z-[5000] cursor-pointer">
                                            Занять Место
                                        </button>) : 
                                        <div className="text-[10px] uppercase font-black opacity-30 mt-3">{isMe ? 'ВАША АНКЕТА' : 'ЗАНЯТО'}</div>}
                                    </div>
                                </div>
                                
                                {['sex', 'age', 'prof', 'health', 'bag', 'hobby', 'phob', 'f1', 'f2'].map(f => {
                                    const isRev = (f === 'sex' || f === 'age') ? (p.revealed?.sex || p.revealed?.age || isMe || isAdmin) : (p.revealed?.[f] || isMe || isAdmin);
                                    const isExp = (f === 'prof' || f === 'hobby'); const expVal = f === 'prof' ? p.profExp : p.hobbyExp;
                                return (
                                 <div key={f} className={`${f==='prof'||f.includes('f')?'col-span-2':''} stat-box relative transition-all duration-500 ${p.revealed?.[f] ? 'stat-revealed' : ''}`}>
                                 {p.revealed?.[f] && ( <div className="absolute top-2 right-2 flex items-center gap-1 scale-90 sm:scale-100"><span className="text-[9px] font-black text-green-400 tracking-tighter opacity-80 uppercase">Вскрыто</span><span className="text-xs text-green-400 drop-shadow-[0_0_5px_rgba(74,222,128,0.8)]">✓</span></div>)}
                                 <span className="stat-label"> {f==='sex'?'Пол':f==='age'?'Возраст':LABELS[f]} {isAdmin && (<span className="flex gap-1"><span onClick={() => update(`players/${pIdx}/${f}`, roll(f))} className="cursor-pointer">🎲</span>{isExp && <span onClick={() => update(`players/${pIdx}/${f+'Exp'}`, roll('years', p.age))} className="cursor-pointer">⏳</span>}</span>)}</span>
                                 {canEdit ? (<div className="flex gap-1"><input className="stat-input" value={p[f]} onChange={e => update(`players/${pIdx}/${f}`, e.target.value)} />{isExp && <input className="stat-input w-16" value={expVal} onChange={e => update(`players/${pIdx}/${f+'Exp'}`, e.target.value)} />}</div>) : (<div className={`font-black text-[14px] uppercase ${!isRev ? 'blur-val' : 'text-white/90'}`}>{isRev ? (isExp ? `${p[f]} (${expVal} лет)` : p[f]) : 'Секрет'}</div>)}
                                 </div> ); })}
                                
                                <div className="grid grid-cols-2 gap-3 mt-6 pt-6 border-t border-white/10">
                                    {p.actions && p.actions.map((c, ci) => (
                                        <div key={ci} className="bg-white/5 border border-white/10 p-4 rounded-xl min-h-[110px] flex flex-col justify-between">
                                            <p className="text-[9px] font-bold uppercase opacity-70">{isMe || isAdmin ? c : 'BUNKER'}</p> 
                                           {isMe && <button onClick={() => triggerCard(pIdx, c, p.name)} className="w-full mt-2 bg-white text-black py-1 rounded text-[8px] font-black uppercase hover:scale-105 transition-transform">ЮЗНУТЬ</button>}</div>
                                    ))}
                                </div>
                                
                                {/* КНОПКА ЗАВЕРШИТЬ РЕЧЬ */}
                                {isTalking && isMe && gameState.phase === 'speaking' && gameState.turnTime > 0 && (
                                    <div className="mt-4 pt-4 border-t border-white/10">
                                         <button onClick={() => { update('turnTime', 0); botSay(`🎤 Объект №${p.id} завершает речь досрочно.`); }} className="w-full bg-white text-black py-3 rounded-xl font-black uppercase hover:bg-gray-200 transition-colors shadow-[0_0_15px_rgba(255,255,255,0.3)]">Завершить речь</button>
                                    </div>
                                )}

                                {/* КНОПКИ МОДЕРАЦИИ КАРТОЧКИ */}
                                {isAdmin && (
                                    <div className="mt-8 flex gap-2 flex-wrap justify-center">
                                        {canPlay && <button onClick={() => { update('turnTime', 0); update('speakerId', isTalking ? null : p.id); }} className={`w-full py-3 rounded-xl font-black text-xs uppercase transition-all mb-2 ${isTalking ? 'bg-red-600 shadow-[0_0_20px_red]' : 'bg-white text-black hover:bg-gray-200'}`}>ДАТЬ СЛОВО</button>}
                                        
                                        {canExile && <button onClick={() => update(`players/${pIdx}/isExiled`, !p.isExiled)} className="bg-red-500/20 border border-red-500 text-red-400 px-4 py-2 rounded-lg font-black text-[10px] uppercase hover:bg-red-500 hover:text-white transition-colors">{p.isExiled ? 'ВОСКРЕСИТЬ' : 'ИЗГНАТЬ'}</button>}
                                        
                                        {canWarn && p.uid && (
                                            <>
                                                <button onClick={() => setPunishModal({uid: p.uid, name: p.name, type: 'warn'})} className="bg-orange-500/20 border border-orange-500 text-orange-400 px-4 py-2 rounded-lg font-black text-[10px] uppercase hover:bg-orange-500 hover:text-white transition-colors">ВАРН</button>
                                                
                                                <button onClick={() => setPunishModal({uid: p.uid, name: p.name, type: 'ban'})} className="bg-black/50 border border-gray-500 text-gray-300 px-4 py-2 rounded-lg font-black text-[10px] uppercase hover:bg-white hover:text-black transition-colors">БАН/РАЗБАН</button>
                                            </>
                                        )}
                                    </div>
                                )}
                            </div>
                        );
                    })}</div>

            {/* КНОПКА ОТКРЫТИЯ ЧАТА */}
            <div onClick={() => setIsChatOpen(!isChatOpen)} className="fixed bottom-6 right-6 bg-blue-600 border-2 border-blue-400 w-16 h-16 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-500 hover:scale-110 z-[9999] shadow-[0_0_20px_rgba(59,130,246,0.5)] transition-all text-2xl">💬</div>
            
            {/* ПАНЕЛЬ ЧАТА (С поднятым z-index, чтобы не пряталась под кнопки) */}
            <div className={`fixed top-0 right-0 h-full w-[450px] bg-[#05050f]/95 backdrop-blur-[45px] border-l border-blue-900/50 p-6 z-[99999] shadow-[-20px_0_50px_rgba(0,0,0,0.8)] transition-transform duration-500 ease-in-out flex flex-col ${isChatOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                <div className="flex justify-between items-center mb-6 border-b border-blue-500/30 pb-4 mt-4">
                    <h3 className="text-xl font-black uppercase tracking-widest text-blue-400 font-mono drop-shadow-[0_0_8px_blue]">КАНАЛ СВЯЗИ ._</h3>
                    <button onClick={() => setIsChatOpen(false)} className="text-blue-500 hover:text-white font-black text-2xl transition-colors">✕</button>
                </div>
                <div className="flex-grow overflow-y-auto mb-4 space-y-4 flex flex-col-reverse pr-2">
                    {messages.slice().reverse().map((m, i) => (
                      <div key={m.id} className={`p-4 rounded-2xl border relative group transition-all ${m.uid === 'ai_bot' ? 'bg-blue-900/20 border-blue-500/50 shadow-[0_0_20px_rgba(59,130,246,0.15)] ml-4' : 'bg-white/5 border-white/10 hover:bg-white/10 mr-4'}`}>
                           {m.uid === 'ai_bot' ? (
                               <div className="flex items-center gap-2 mb-3 border-b border-blue-500/30 pb-2">
                                   <span className="text-xl">🤖</span>
                                   <span className="font-black uppercase tracking-widest text-[12px] text-blue-400 drop-shadow-[0_0_8px_blue]">{m.name}</span>
                                   <span className="opacity-50 text-[9px] font-mono ml-auto text-blue-300">{new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                               </div>
                           ) : (
                               <div className="flex justify-between items-baseline mb-2 border-b border-white/5 pb-2">
                                   <span className={`font-black uppercase tracking-widest text-[11px] ${m.role === 'owner' ? 'text-red-500 drop-shadow-[0_0_5px_red]' : m.role === 'admin' ? 'text-yellow-400 drop-shadow-[0_0_5px_yellow]' : m.role === 'curator' ? 'text-purple-400' : m.role === 'tester' ? 'text-orange-400' : 'text-green-400'}`}>{m.name || "ОБЪЕКТ"} <span className="text-[8px] opacity-50">[{m.role}]</span></span>
                                   <span className="opacity-40 text-[10px] text-white/70 font-mono">{new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                               </div>
                           )}
                           <p className={`leading-relaxed text-[13px] break-words font-medium whitespace-pre-wrap ${m.uid === 'ai_bot' ? 'text-blue-100' : 'text-white/90'}`}>{m.text}</p>
                           {(role === 'owner' || role === 'admin' || role === 'curator') && m.uid !== 'ai_bot' && (
                               <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity flex gap-3 bg-black/80 px-3 py-1.5 rounded-xl border border-white/10">
                                   {m.uid && <button onClick={() => toggleMute(m.uid, m.name)} title="Выдать/Снять мут" className="text-blue-400 hover:text-blue-300 text-lg hover:scale-110 transition-transform">🔇</button>}
                                   <button onClick={() => deleteMsg(m.id)} title="Удалить сообщение" className="text-red-500 hover:text-red-400 text-lg hover:scale-110 transition-transform">🗑</button>
                               </div>
                           )}
                      </div>
                    ))}
                </div>
                <div className="flex gap-3 items-center bg-blue-900/20 border border-blue-500/30 rounded-2xl px-4 py-4 mt-auto mb-4 focus-within:border-blue-400 focus-within:shadow-[0_0_15px_rgba(59,130,246,0.3)] transition-all">
                    <span className="text-blue-400 font-bold animate-pulse font-mono">{">"}</span>
                    <input value={msgInput} onChange={e => setMsgInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && sendChat()} className="bg-transparent flex-grow outline-none text-white transition-colors placeholder-blue-300/30 text-[14px] font-medium" placeholder={isMuted ? "Вам выдан мут..." : "Сообщение в бункер..."} disabled={isMuted} />
                </div>
            </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script></body></html>